---
phase: 05-productos-clientes
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - nandefact-api/src/domain/producto/Producto.ts
  - nandefact-api/src/domain/producto/IProductoRepository.ts
  - nandefact-api/src/application/productos/CrearProducto.ts
  - nandefact-api/src/application/productos/EditarProducto.ts
  - nandefact-api/src/application/productos/ListarProductos.ts
  - nandefact-api/src/application/errors/ProductoNoEncontradoError.ts
  - nandefact-api/tests/unit/domain/entities/Producto.test.ts
  - nandefact-api/tests/unit/application/productos/CrearProducto.test.ts
  - nandefact-api/tests/unit/application/productos/EditarProducto.test.ts
  - nandefact-api/tests/unit/application/productos/ListarProductos.test.ts
autonomous: true

must_haves:
  truths:
    - "User can create product with nombre, precio PYG (integer), tasa IVA (10/5/0), unidad medida"
    - "User can edit existing product fields (nombre, precio, IVA, unidad medida)"
    - "User can soft-delete product (activo=false), not hard delete"
    - "System returns paginated list of products filtered by comercioId"
    - "Product validates nombre non-empty, precio positive integer, tasa IVA valid (10/5/0)"
  artifacts:
    - path: "nandefact-api/src/domain/producto/Producto.ts"
      provides: "Producto domain entity with validation"
      contains: "class Producto"
    - path: "nandefact-api/src/domain/producto/IProductoRepository.ts"
      provides: "Repository port for products"
      exports: ["IProductoRepository"]
    - path: "nandefact-api/src/application/productos/CrearProducto.ts"
      provides: "Create product use case"
      exports: ["CrearProducto", "CrearProductoInput", "CrearProductoOutput"]
    - path: "nandefact-api/src/application/productos/EditarProducto.ts"
      provides: "Edit product + soft-delete use case"
      exports: ["EditarProducto", "EditarProductoInput"]
    - path: "nandefact-api/src/application/productos/ListarProductos.ts"
      provides: "Paginated product list use case"
      exports: ["ListarProductos", "ListarProductosInput", "ListarProductosOutput"]
  key_links:
    - from: "nandefact-api/src/application/productos/CrearProducto.ts"
      to: "nandefact-api/src/domain/producto/IProductoRepository.ts"
      via: "deps.productoRepository.save()"
      pattern: "productoRepository\\.save"
    - from: "nandefact-api/src/application/productos/ListarProductos.ts"
      to: "nandefact-api/src/domain/producto/IProductoRepository.ts"
      via: "deps.productoRepository.findByComercio()"
      pattern: "productoRepository\\.findByComercio"
---

<objective>
Create the Producto domain entity, IProductoRepository port, and CRUD use cases (CrearProducto, EditarProducto, ListarProductos) with TDD.

Purpose: Products are core to the facturacion flow -- Dona Maria needs to manage her product catalog (mandioca, chipas, etc.) so she can quickly select items when creating invoices.
Output: Fully tested Producto domain entity + 3 application use cases with tests.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing patterns to follow
@nandefact-api/src/domain/cliente/Cliente.ts
@nandefact-api/src/domain/cliente/IClienteRepository.ts
@nandefact-api/src/application/facturacion/CrearFactura.ts
@nandefact-api/src/domain/shared/types.ts
@nandefact-api/src/application/errors/ApplicationError.ts
@nandefact-api/src/application/errors/ComercioNoEncontradoError.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Producto entity + IProductoRepository port + domain tests</name>
  <files>
    nandefact-api/src/domain/producto/Producto.ts
    nandefact-api/src/domain/producto/IProductoRepository.ts
    nandefact-api/tests/unit/domain/entities/Producto.test.ts
  </files>
  <action>
    Delete the `.gitkeep` in `src/domain/producto/`.

    Create `Producto.ts` following the Cliente.ts pattern:

    ```typescript
    interface ProductoProps {
      id: string;
      comercioId: string;
      nombre: string;           // required, non-empty after trim
      codigo?: string;          // optional product code
      precioUnitario: number;   // PYG integer, must be > 0
      unidadMedida: string;     // required, non-empty (e.g. "UN", "KG", "LT")
      tasaIVA: TasaIVA;         // 10 | 5 | 0 from shared/types
      categoria?: string;       // optional category
      activo?: boolean;         // defaults true
    }
    ```

    Validations in constructor:
    - `nombre.trim().length === 0` -> throw DomainError "El nombre del producto no puede estar vacio"
    - `precioUnitario <= 0` -> throw DomainError "El precio unitario debe ser mayor a 0"
    - `!Number.isInteger(precioUnitario)` -> throw DomainError "El precio unitario debe ser un entero (guaranies sin decimales)"
    - `unidadMedida.trim().length === 0` -> throw DomainError "La unidad de medida no puede estar vacia"
    - `![10, 5, 0].includes(tasaIVA)` -> throw DomainError "La tasa IVA debe ser 10, 5, o 0"

    Add methods:
    - `desactivar(): Producto` -> returns new Producto with activo=false (immutable pattern)
    - `actualizar(cambios: Partial<Omit<ProductoProps, 'id' | 'comercioId'>>): Producto` -> returns new Producto merging changes, re-validates everything

    Create `IProductoRepository.ts` following IClienteRepository pattern:
    ```typescript
    export interface IProductoRepository {
      save(producto: Producto): Promise<void>;
      findById(id: string): Promise<Producto | null>;
      findByComercio(comercioId: string, options?: { page?: number; pageSize?: number; soloActivos?: boolean }): Promise<{ productos: Producto[]; total: number }>;
    }
    ```

    Note: `findByComercio` returns paginated result with `total` count. Default `soloActivos=true`. Default `page=1`, `pageSize=20`.

    Write tests RED then GREEN:
    - Creates valid product
    - Rejects empty nombre
    - Rejects zero/negative precio
    - Rejects non-integer precio (e.g. 1500.50)
    - Rejects empty unidadMedida
    - Rejects invalid tasaIVA
    - Defaults activo=true
    - desactivar() returns new Producto with activo=false
    - actualizar() returns new Producto with merged changes
    - actualizar() re-validates (e.g. empty nombre after update throws)
  </action>
  <verify>
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run tests/unit/domain/entities/Producto.test.ts`
    All tests pass.
  </verify>
  <done>
    Producto entity validates all fields, supports immutable update and deactivation. IProductoRepository port exists with paginated findByComercio. All domain tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: CrearProducto + EditarProducto + ListarProductos use cases with tests</name>
  <files>
    nandefact-api/src/application/productos/CrearProducto.ts
    nandefact-api/src/application/productos/EditarProducto.ts
    nandefact-api/src/application/productos/ListarProductos.ts
    nandefact-api/src/application/errors/ProductoNoEncontradoError.ts
    nandefact-api/tests/unit/application/productos/CrearProducto.test.ts
    nandefact-api/tests/unit/application/productos/EditarProducto.test.ts
    nandefact-api/tests/unit/application/productos/ListarProductos.test.ts
  </files>
  <action>
    Create `ProductoNoEncontradoError.ts` extending ApplicationError (follow ComercioNoEncontradoError pattern).

    **CrearProducto use case:**
    - Constructor takes `deps: { productoRepository: IProductoRepository; comercioRepository: IComercioRepository; }`
    - Input: `{ comercioId, nombre, codigo?, precioUnitario, unidadMedida, tasaIVA, categoria? }`
    - Output: `{ productoId: string }`
    - Flow: validate comercio exists (throw ComercioNoEncontradoError), generate UUID, create Producto entity, save via repository
    - Tests: success case, comercio not found, domain validation errors propagate

    **EditarProducto use case:**
    - Constructor takes `deps: { productoRepository: IProductoRepository; }`
    - Input: `{ productoId: string; cambios: { nombre?, codigo?, precioUnitario?, unidadMedida?, tasaIVA?, categoria?, activo? } }`
    - Output: `void`
    - Flow: load producto (throw ProductoNoEncontradoError if missing), if `cambios.activo === false` use `desactivar()`, otherwise use `actualizar(cambios)`, save
    - Tests: success edit nombre, success soft-delete (activo=false), producto not found, validation error on invalid update

    **ListarProductos use case:**
    - Constructor takes `deps: { productoRepository: IProductoRepository; }`
    - Input: `{ comercioId: string; page?: number; pageSize?: number; soloActivos?: boolean }`
    - Output: `{ productos: Array<{ id, nombre, codigo, precioUnitario, unidadMedida, tasaIVA, categoria, activo }>; total: number; page: number; pageSize: number }`
    - Flow: call `productoRepository.findByComercio(comercioId, { page, pageSize, soloActivos })`, map to output DTOs
    - Defaults: page=1, pageSize=20, soloActivos=true
    - Tests: returns paginated list, empty list, custom page/pageSize, includes total

    All use cases follow the `deps` object constructor pattern from CrearFactura.
  </action>
  <verify>
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run tests/unit/application/productos/`
    All tests pass.
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run` to confirm zero regressions.
  </verify>
  <done>
    Three product use cases (create, edit, list) work correctly with tests. ProductoNoEncontradoError exists. Full test suite passes with zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run` â€” all tests pass (213 existing + new product tests)
2. Producto entity has all validations (nombre, precio, unidadMedida, tasaIVA)
3. IProductoRepository port has save, findById, findByComercio with pagination
4. Three use cases exist with proper deps injection pattern
5. ProductoNoEncontradoError extends ApplicationError
</verification>

<success_criteria>
- Producto entity validates: nombre non-empty, precio positive integer, unidadMedida non-empty, tasaIVA in (10,5,0)
- Producto supports immutable desactivar() and actualizar()
- CrearProducto validates comercio exists before creating
- EditarProducto handles both field updates and soft-delete
- ListarProductos returns paginated results with total count
- All new tests pass, zero regressions on existing 213 tests
</success_criteria>

<output>
After completion, create `.planning/phases/05-productos-clientes/05-01-SUMMARY.md`
</output>
