---
phase: 05-productos-clientes
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - nandefact-api/src/application/clientes/CrearCliente.ts
  - nandefact-api/src/application/clientes/EditarCliente.ts
  - nandefact-api/src/application/clientes/BuscarClientes.ts
  - nandefact-api/src/application/clientes/ConsultarRUC.ts
  - nandefact-api/src/application/errors/ClienteNoEncontradoError.ts
  - nandefact-api/src/domain/factura/ISifenGateway.ts
  - nandefact-api/src/domain/cliente/IClienteRepository.ts
  - nandefact-api/src/domain/cliente/Cliente.ts
  - nandefact-api/src/application/facturacion/EnviarKuDE.ts
  - nandefact-api/src/domain/errors/FacturaNoEncontradaError.ts
  - nandefact-api/src/infrastructure/sifen/SifenGatewayImpl.ts
  - nandefact-api/tests/unit/application/clientes/CrearCliente.test.ts
  - nandefact-api/tests/unit/application/clientes/EditarCliente.test.ts
  - nandefact-api/tests/unit/application/clientes/BuscarClientes.test.ts
  - nandefact-api/tests/unit/application/clientes/ConsultarRUC.test.ts
  - nandefact-api/tests/unit/application/facturacion/EnviarKuDE.test.ts
autonomous: true

must_haves:
  truths:
    - "User can create client with CI/RUC/pasaporte or as innominado"
    - "User can edit existing client fields"
    - "System autocompletes client search by nombre/RUC/CI"
    - "System validates RUC format using existing RUC value object"
    - "System can query SIFEN siConsRUC for RUC verification"
    - "Duplicate FacturaNoEncontradaError is consolidated to application layer only"
    - "EnviarKuDE uses deps object pattern consistent with all other use cases"
  artifacts:
    - path: "nandefact-api/src/application/clientes/CrearCliente.ts"
      provides: "Create client use case"
      exports: ["CrearCliente", "CrearClienteInput", "CrearClienteOutput"]
    - path: "nandefact-api/src/application/clientes/EditarCliente.ts"
      provides: "Edit client use case"
      exports: ["EditarCliente", "EditarClienteInput"]
    - path: "nandefact-api/src/application/clientes/BuscarClientes.ts"
      provides: "Search/autocomplete client use case"
      exports: ["BuscarClientes", "BuscarClientesInput", "BuscarClientesOutput"]
    - path: "nandefact-api/src/application/clientes/ConsultarRUC.ts"
      provides: "Verify RUC against SIFEN use case"
      exports: ["ConsultarRUC", "ConsultarRUCInput", "ConsultarRUCOutput"]
    - path: "nandefact-api/src/domain/factura/ISifenGateway.ts"
      provides: "Updated gateway port with consultarRUC method"
      contains: "consultarRUC"
  key_links:
    - from: "nandefact-api/src/application/clientes/CrearCliente.ts"
      to: "nandefact-api/src/domain/cliente/IClienteRepository.ts"
      via: "deps.clienteRepository.save()"
      pattern: "clienteRepository\\.save"
    - from: "nandefact-api/src/application/clientes/ConsultarRUC.ts"
      to: "nandefact-api/src/domain/factura/ISifenGateway.ts"
      via: "deps.sifenGateway.consultarRUC()"
      pattern: "sifenGateway\\.consultarRUC"
    - from: "nandefact-api/src/application/clientes/BuscarClientes.ts"
      to: "nandefact-api/src/domain/cliente/IClienteRepository.ts"
      via: "deps.clienteRepository.buscar()"
      pattern: "clienteRepository\\.buscar"
---

<objective>
Create Cliente CRUD use cases (CrearCliente, EditarCliente, BuscarClientes), ConsultarRUC use case for SIFEN verification, and clean up code review issues (duplicate FacturaNoEncontradaError, EnviarKuDE positional args).

Purpose: Clients are the recipients of invoices. Dona Maria needs to quickly find returning customers (autocompletado) and optionally verify their RUC against SIFEN before invoicing.
Output: 4 tested use cases + code cleanup + zero regressions.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing code
@nandefact-api/src/domain/cliente/Cliente.ts
@nandefact-api/src/domain/cliente/IClienteRepository.ts
@nandefact-api/src/domain/factura/ISifenGateway.ts
@nandefact-api/src/domain/comercio/RUC.ts
@nandefact-api/src/application/facturacion/EnviarKuDE.ts
@nandefact-api/src/application/facturacion/CrearFactura.ts
@nandefact-api/src/application/errors/ApplicationError.ts
@nandefact-api/src/application/errors/FacturaNoEncontradaError.ts
@nandefact-api/src/domain/errors/FacturaNoEncontradaError.ts
@nandefact-api/src/infrastructure/sifen/SifenGatewayImpl.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Code cleanup — consolidate duplicate error + fix EnviarKuDE pattern</name>
  <files>
    nandefact-api/src/domain/errors/FacturaNoEncontradaError.ts
    nandefact-api/src/application/facturacion/EnviarKuDE.ts
    nandefact-api/tests/unit/application/facturacion/EnviarKuDE.test.ts
  </files>
  <action>
    **Fix 1: Consolidate duplicate FacturaNoEncontradaError.**

    The domain version (`src/domain/errors/FacturaNoEncontradaError.ts` extending DomainError) should be DELETED. "Factura not found" is an application-layer concern (use case loading an entity) not a domain invariant. All use cases should use the application version.

    - Delete `src/domain/errors/FacturaNoEncontradaError.ts`
    - Update `EnviarKuDE.ts` import from `../../domain/errors/FacturaNoEncontradaError.js` to `../errors/FacturaNoEncontradaError.js` (application layer version)
    - Verify no other file imports from domain errors version (grep confirms only EnviarKuDE does)

    **Fix 2: Convert EnviarKuDE to deps object pattern.**

    Current:
    ```typescript
    constructor(
      private facturaRepository: IFacturaRepository,
      private comercioRepository: IComercioRepository,
      private clienteRepository: IClienteRepository,
      private kudeGenerator: IKudeGenerator,
      private notificador: INotificador
    )
    ```

    Change to:
    ```typescript
    constructor(
      private readonly deps: {
        facturaRepository: IFacturaRepository;
        comercioRepository: IComercioRepository;
        clienteRepository: IClienteRepository;
        kudeGenerator: IKudeGenerator;
        notificador: INotificador;
      }
    )
    ```

    Update all internal references from `this.facturaRepository` to `this.deps.facturaRepository`, etc. Also rename `ejecutar` to `execute` for consistency with other use cases (CrearFactura uses `execute`).

    **Update EnviarKuDE tests** to use new constructor pattern and method name. Run existing tests to confirm they still pass after adaptation.
  </action>
  <verify>
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run tests/unit/application/facturacion/EnviarKuDE.test.ts`
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run` to confirm zero regressions across all 213 tests.
    Verify `src/domain/errors/FacturaNoEncontradaError.ts` no longer exists.
  </verify>
  <done>
    Duplicate FacturaNoEncontradaError eliminated. EnviarKuDE uses deps object + execute() method. All tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Cliente CRUD use cases + ConsultarRUC + ISifenGateway update</name>
  <files>
    nandefact-api/src/application/clientes/CrearCliente.ts
    nandefact-api/src/application/clientes/EditarCliente.ts
    nandefact-api/src/application/clientes/BuscarClientes.ts
    nandefact-api/src/application/clientes/ConsultarRUC.ts
    nandefact-api/src/application/errors/ClienteNoEncontradoError.ts
    nandefact-api/src/domain/factura/ISifenGateway.ts
    nandefact-api/src/domain/cliente/IClienteRepository.ts
    nandefact-api/src/domain/cliente/Cliente.ts
    nandefact-api/src/infrastructure/sifen/SifenGatewayImpl.ts
    nandefact-api/tests/unit/application/clientes/CrearCliente.test.ts
    nandefact-api/tests/unit/application/clientes/EditarCliente.test.ts
    nandefact-api/tests/unit/application/clientes/BuscarClientes.test.ts
    nandefact-api/tests/unit/application/clientes/ConsultarRUC.test.ts
  </files>
  <action>
    **Step 1: Update Cliente entity** to support updates.
    Add method to Cliente.ts:
    ```typescript
    actualizar(cambios: Partial<Omit<ClienteProps, 'id' | 'comercioId'>>): Cliente
    ```
    Returns new Cliente with merged props, re-validates. Same immutable pattern as Producto.

    **Step 2: Update IClienteRepository** to add pagination to findByComercio:
    Change `findByComercio(comercioId: string): Promise<Cliente[]>` to keep backward compatibility but note that the CRUD use case will use `buscar` for search. No breaking change needed since `buscar` already exists.

    **Step 3: Create ClienteNoEncontradoError** extending ApplicationError.

    **Step 4: ISifenGateway — add consultarRUC method:**
    ```typescript
    export interface ConsultaRUCResponse {
      encontrado: boolean;
      razonSocial: string | null;
      ruc: string;
    }
    ```
    Add to ISifenGateway: `consultarRUC(ruc: string): Promise<ConsultaRUCResponse>;`

    **Step 5: Update SifenGatewayImpl** to add stub `consultarRUC` method using TIPS-SA setapi's `consulta` function. For now, implement with the library pattern:
    ```typescript
    async consultarRUC(ruc: string): Promise<ConsultaRUCResponse> {
      // Usa siConsRUC via setapi
      const response = await this.setApi.consulta(ruc, this.config);
      // Parse response for razonSocial
      return { encontrado: true/false, razonSocial, ruc };
    }
    ```
    If the library doesn't clearly expose siConsRUC, implement as a placeholder that throws "No implementado" — the real integration will be in infrastructure testing phase.

    **Step 6: CrearCliente use case:**
    - deps: `{ clienteRepository: IClienteRepository; comercioRepository: IComercioRepository; }`
    - Input: `{ comercioId, nombre, rucCi, tipoDocumento, telefono?, email?, direccion?, frecuente?, enviarWhatsApp? }`
    - Output: `{ clienteId: string }`
    - Flow: validate comercio exists, if tipoDocumento==='RUC' validate RUC format using `new RUC(rucCi)` (catches RUCInvalidoError and wraps in descriptive error), generate UUID, create Cliente, save
    - Tests: success case, innominado without rucCi, comercio not found, invalid RUC format

    **Step 7: EditarCliente use case:**
    - deps: `{ clienteRepository: IClienteRepository; }`
    - Input: `{ clienteId: string; cambios: Partial<{ nombre, rucCi, tipoDocumento, telefono, email, direccion, frecuente, enviarWhatsApp }> }`
    - Output: `void`
    - Flow: load cliente (throw ClienteNoEncontradoError), use `cliente.actualizar(cambios)`, save
    - Tests: success edit, cliente not found, validation error on empty nombre

    **Step 8: BuscarClientes use case:**
    - deps: `{ clienteRepository: IClienteRepository; }`
    - Input: `{ comercioId: string; query: string }`
    - Output: `{ clientes: Array<{ id, nombre, rucCi, tipoDocumento, telefono }> }`
    - Flow: call `clienteRepository.buscar(comercioId, query)`, map to output DTOs
    - Validation: query must be at least 2 characters (prevents full-table scan on every keystroke)
    - Tests: returns matching clients, empty results, rejects single-char query

    **Step 9: ConsultarRUC use case:**
    - deps: `{ sifenGateway: ISifenGateway; }`
    - Input: `{ ruc: string }`
    - Output: `{ encontrado: boolean; razonSocial: string | null; ruc: string }`
    - Flow: validate RUC format using `new RUC(ruc)` first (throws RUCInvalidoError for invalid format), then call `sifenGateway.consultarRUC(ruc)`
    - Tests: success found, success not found, invalid RUC format, gateway error handling
  </action>
  <verify>
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run tests/unit/application/clientes/`
    All client tests pass.
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run` to confirm zero regressions.
    Verify ISifenGateway has `consultarRUC` method.
  </verify>
  <done>
    Four client use cases work correctly. ISifenGateway has consultarRUC. RUC validation reuses existing value object. All tests pass including existing 213+ tests.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run` — all tests pass (existing + new)
2. `src/domain/errors/FacturaNoEncontradaError.ts` does NOT exist (deleted)
3. EnviarKuDE uses `deps` object and `execute()` method
4. ISifenGateway has `consultarRUC(ruc: string): Promise<ConsultaRUCResponse>`
5. ConsultarRUC validates RUC format before calling gateway
6. BuscarClientes rejects queries shorter than 2 characters
7. CrearCliente validates RUC format for tipoDocumento==='RUC'
</verification>

<success_criteria>
- CrearCliente validates RUC format when tipoDocumento is 'RUC'
- CrearCliente creates innominado clients without rucCi
- EditarCliente handles field updates with re-validation
- BuscarClientes searches by nombre/RUC/CI with minimum 2-char query
- ConsultarRUC validates format then queries SIFEN gateway
- Duplicate FacturaNoEncontradaError resolved (domain version deleted)
- EnviarKuDE refactored to deps pattern + execute() method
- All tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/05-productos-clientes/05-02-SUMMARY.md`
</output>
