---
phase: 04-events-kude
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - nandefact-api/package.json
  - nandefact-api/src/domain/factura/IKudeGenerator.ts
  - nandefact-api/src/infrastructure/kude/KudeGeneratorImpl.ts
  - nandefact-api/src/infrastructure/kude/QrGeneratorSifen.ts
  - nandefact-api/src/infrastructure/notificador/NotificadorStub.ts
  - nandefact-api/src/application/facturacion/EnviarKuDE.ts
  - nandefact-api/tests/unit/infrastructure/kude/KudeGeneratorImpl.test.ts
  - nandefact-api/tests/unit/infrastructure/kude/QrGeneratorSifen.test.ts
  - nandefact-api/tests/unit/infrastructure/notificador/NotificadorStub.test.ts
  - nandefact-api/tests/unit/application/facturacion/EnviarKuDE.test.ts
autonomous: true

must_haves:
  truths:
    - "System generates KuDE PDF buffer from factura + comercio + cliente data"
    - "KuDE includes QR code with CDC + CSC hash following e-Kuatia URL format"
    - "EnviarKuDE use case generates PDF and sends via INotificador port"
    - "INotificador has a stub implementation that logs instead of sending WhatsApp"
  artifacts:
    - path: "nandefact-api/src/infrastructure/kude/KudeGeneratorImpl.ts"
      provides: "KuDE PDF generation adapter"
      exports: ["KudeGeneratorImpl"]
    - path: "nandefact-api/src/infrastructure/kude/QrGeneratorSifen.ts"
      provides: "QR code generation for SIFEN verification URL"
      exports: ["QrGeneratorSifen"]
    - path: "nandefact-api/src/infrastructure/notificador/NotificadorStub.ts"
      provides: "Stub notificador that logs instead of sending WhatsApp"
      exports: ["NotificadorStub"]
    - path: "nandefact-api/src/application/facturacion/EnviarKuDE.ts"
      provides: "Use case to generate and send KuDE"
      exports: ["EnviarKuDE"]
  key_links:
    - from: "nandefact-api/src/infrastructure/kude/KudeGeneratorImpl.ts"
      to: "facturacionelectronicapy-kude"
      via: "TIPS-SA kude library for PDF generation"
      pattern: "facturacionelectronicapy-kude"
    - from: "nandefact-api/src/infrastructure/kude/QrGeneratorSifen.ts"
      to: "facturacionelectronicapy-qrgen"
      via: "TIPS-SA qrgen library for QR code"
      pattern: "facturacionelectronicapy-qrgen"
    - from: "nandefact-api/src/application/facturacion/EnviarKuDE.ts"
      to: "nandefact-api/src/domain/factura/IKudeGenerator.ts"
      via: "kudeGenerator.generar() call"
      pattern: "kudeGenerator\\.generar"
    - from: "nandefact-api/src/application/facturacion/EnviarKuDE.ts"
      to: "nandefact-api/src/domain/factura/INotificador.ts"
      via: "notificador.enviarKuDE() call"
      pattern: "notificador\\.enviarKuDE"
---

<objective>
Implement KuDE PDF generation with QR code and a stub WhatsApp notificador.

Purpose: Completes KUDE-01 (PDF generation with mandatory fields + QR) and KUDE-02 (INotificador port stub). Enables the system to produce the legally-required printed/digital representation of a DTE with a verifiable QR code.

Output: Working KuDE PDF generator, QR code generator, EnviarKuDE use case, and NotificadorStub -- all with tests.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@nandefact-api/src/domain/factura/IKudeGenerator.ts
@nandefact-api/src/domain/factura/INotificador.ts
@nandefact-api/src/domain/factura/Factura.ts
@nandefact-api/src/domain/comercio/Comercio.ts
@nandefact-api/src/domain/cliente/Cliente.ts
@nandefact-api/src/infrastructure/sifen/SifenDataMapper.ts
@nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts
@nandefact-api/package.json
@SIFEN_REFERENCIA_COMPLETA.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install TIPS-SA libraries + implement QR generator + KuDE PDF generator</name>
  <files>
    nandefact-api/package.json
    nandefact-api/src/domain/factura/IKudeGenerator.ts
    nandefact-api/src/infrastructure/kude/QrGeneratorSifen.ts
    nandefact-api/src/infrastructure/kude/KudeGeneratorImpl.ts
    nandefact-api/tests/unit/infrastructure/kude/QrGeneratorSifen.test.ts
    nandefact-api/tests/unit/infrastructure/kude/KudeGeneratorImpl.test.ts
  </files>
  <action>
    **Step 1: Install TIPS-SA packages**

    Run: `cd nandefact-api && npm install facturacionelectronicapy-qrgen facturacionelectronicapy-kude`

    These are CommonJS packages (same as xmlgen/xmlsign/setapi). Use dynamic import pattern established in XmlGeneratorSifen.ts.

    **Step 2: Update IKudeGenerator port**

    The existing port signature `generar(factura: Factura): Promise<Buffer>` is insufficient -- KuDE needs comercio data (RUC, razon social, timbrado) and cliente data. Update to:
    ```typescript
    import type { Factura } from './Factura.js';
    import type { Comercio } from '../comercio/Comercio.js';
    import type { Cliente } from '../cliente/Cliente.js';

    export interface IKudeGenerator {
      generar(factura: Factura, comercio: Comercio, cliente: Cliente): Promise<Buffer>;
    }
    ```

    **Step 3: Create QrGeneratorSifen**

    Create `src/infrastructure/kude/QrGeneratorSifen.ts`:
    - Purpose: Generate QR code data/image for KuDE following SIFEN spec (section 9 of SIFEN_REFERENCIA_COMPLETA.md)
    - QR URL format: `https://ekuatia.set.gov.py/consultas/qr?nVersion=150&Id={CDC}&dFeEmiDE={fechaEmision}&dRucRec={rucReceptor}&dTotGralOpe={totalGeneral}&dTotIVA={totalIVA}&cItems={cantidadItems}&DigestValue={digestValue}&IdCSC={idCSC}&cHashQR={hashQR}`
    - Use `facturacionelectronicapy-qrgen` library via dynamic import
    - Explore the qrgen library API first (it's CommonJS). It likely has a method like `generateQR(data)` that takes CDC, CSC, and other parameters.
    - If the library API is unclear, check `node_modules/facturacionelectronicapy-qrgen/index.js` for exports.
    - Export class `QrGeneratorSifen` with method:
      ```typescript
      async generarQr(params: {
        cdc: string;
        fechaEmision: string;  // ISO format
        rucReceptor: string;
        totalGeneral: number;
        totalIVA: number;
        cantidadItems: number;
        cscId: string;
        csc: string;
      }): Promise<string>  // Returns QR data URL or base64 image
      ```
    - The CSC (Codigo Seguridad Contribuyente) comes from the comercio's configuration. For now, accept it as parameter. It will be loaded from Comercio entity in a future phase when Comercio has csc/cscId fields.

    **Step 4: Create KudeGeneratorImpl**

    Create `src/infrastructure/kude/KudeGeneratorImpl.ts`:
    - Implements `IKudeGenerator` port
    - Dependencies: QrGeneratorSifen (injected), cscId and csc config strings
    - Use `facturacionelectronicapy-kude` library via dynamic import
    - Explore the kude library API first (CommonJS). It likely generates PDF from DE data + QR.
    - If the library API is unclear, check `node_modules/facturacionelectronicapy-kude/index.js` for exports.
    - Map Factura + Comercio + Cliente to the structure the kude library expects (similar to SifenDataMapper pattern)
    - The generar() method should:
      1. Generate QR using QrGeneratorSifen
      2. Map domain entities to kude library format
      3. Call kude library to generate PDF
      4. Return PDF as Buffer
    - If the kude library is too complex or its API doesn't match, create a SIMPLER fallback: generate a basic PDF using a lightweight approach (the important thing is the PORT works and can be swapped later). Document the approach taken.

    **Step 5: Tests**

    Create `tests/unit/infrastructure/kude/QrGeneratorSifen.test.ts`:
    - Mock the qrgen library (dynamic import mock pattern from SifenGatewayImpl tests)
    - Test that generarQr builds correct URL parameters
    - Test that CDC and CSC are included in hash computation
    - Test with sample data matching SIFEN spec

    Create `tests/unit/infrastructure/kude/KudeGeneratorImpl.test.ts`:
    - Mock the kude library and QrGeneratorSifen
    - Test that generar() calls QR generator with correct factura data
    - Test that generar() passes correct data to kude library
    - Test that generar() returns Buffer from kude library result
    - Test that it throws if factura has no CDC (can't generate QR without CDC)

    IMPORTANT: These libraries are CommonJS. Use the established dynamic import mock pattern from the project. Follow the same mock approach used in `tests/unit/infrastructure/sifen/SifenGatewayImpl.test.ts`.
  </action>
  <verify>Run `cd nandefact-api && npx vitest run tests/unit/infrastructure/kude/` -- all new tests pass. Run `cd nandefact-api && npx tsc --noEmit` -- no type errors.</verify>
  <done>facturacionelectronicapy-qrgen and facturacionelectronicapy-kude installed. QrGeneratorSifen generates QR with CDC+CSC hash. KudeGeneratorImpl generates PDF Buffer from factura+comercio+cliente. IKudeGenerator port updated to accept comercio+cliente. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: EnviarKuDE use case + NotificadorStub</name>
  <files>
    nandefact-api/src/application/facturacion/EnviarKuDE.ts
    nandefact-api/src/infrastructure/notificador/NotificadorStub.ts
    nandefact-api/tests/unit/application/facturacion/EnviarKuDE.test.ts
    nandefact-api/tests/unit/infrastructure/notificador/NotificadorStub.test.ts
  </files>
  <action>
    **Part A: Create EnviarKuDE use case**

    Create `src/application/facturacion/EnviarKuDE.ts`:
    ```typescript
    export interface EnviarKuDEInput {
      facturaId: string;
    }

    export interface EnviarKuDEOutput {
      pdfGenerado: boolean;
      notificacionEnviada: boolean;
      telefono: string | null;
    }
    ```

    Dependencies (injected):
    - IFacturaRepository (load factura)
    - IComercioRepository (load comercio for KuDE header data)
    - IClienteRepository (load cliente for recipient data)
    - IKudeGenerator (generate PDF)
    - INotificador (send via WhatsApp)

    Execute flow:
    1. Load factura by ID. Throw FacturaNoEncontradaError if not found.
    2. Validate factura.estado === 'aprobado' (only generate KuDE for approved DTE). Throw Error if not approved. NOTE: Also allow 'cancelado' state for KuDE -- a cancelled factura may still need its KuDE sent.
    3. Validate factura has CDC (required for QR). Throw Error if no CDC.
    4. Load comercio by factura.comercioId. Throw ComercioNoEncontradoError if not found.
    5. Load cliente by factura.clienteId. Throw Error if not found.
    6. Generate PDF: `const pdfBuffer = await kudeGenerator.generar(factura, comercio, cliente)`
    7. Check if cliente has telefono AND cliente.enviarWhatsApp === true
    8. If yes: `await notificador.enviarKuDE(cliente.telefono, pdfBuffer)` -- set notificacionEnviada = true
    9. If no: skip notification -- set notificacionEnviada = false
    10. Return { pdfGenerado: true, notificacionEnviada, telefono: cliente.telefono }

    **Part B: Create NotificadorStub**

    Create `src/infrastructure/notificador/NotificadorStub.ts`:
    - Implements INotificador port
    - `enviarKuDE(telefono, pdfBuffer)`: logs "KuDE enviado a {telefono} ({pdfBuffer.length} bytes)" using console.log
    - Does NOT actually send anything (no Meta API integration yet, per KUDE-02 requirement)
    - This is a placeholder that will be replaced with WhatsAppNotificador in a future phase

    **Part C: Tests**

    Create `tests/unit/application/facturacion/EnviarKuDE.test.ts`:
    - Test happy path: approved factura + cliente with telefono + enviarWhatsApp=true -> PDF generated + notification sent
    - Test: approved factura + cliente without telefono -> PDF generated + notification NOT sent
    - Test: approved factura + cliente with enviarWhatsApp=false -> PDF generated + notification NOT sent
    - Test: factura not found -> throws FacturaNoEncontradaError
    - Test: factura in 'pendiente' state -> throws error
    - Test: factura without CDC -> throws error
    - Mock IKudeGenerator to return Buffer.from('fake-pdf')
    - Mock INotificador to verify it's called with correct args
    - Follow same mock patterns as AnularFactura.test.ts for repositories

    Create `tests/unit/infrastructure/notificador/NotificadorStub.test.ts`:
    - Test that enviarKuDE doesn't throw
    - Test that enviarKuDE logs the expected message (spy on console.log)
    - Test with valid telefono and Buffer
  </action>
  <verify>Run `cd nandefact-api && npx vitest run` -- ALL tests pass (existing 172+ plus all new tests from Plan 01 and Plan 02). Run `cd nandefact-api && npx tsc --noEmit && npx eslint src/ tests/` -- clean.</verify>
  <done>EnviarKuDE use case generates PDF via IKudeGenerator and sends via INotificador when cliente has telefono + enviarWhatsApp=true. NotificadorStub logs instead of sending. All tests pass with zero regressions.</done>
</task>

</tasks>

<verification>
1. `cd nandefact-api && npx vitest run` -- all tests pass (172 existing + new KuDE/QR/notificador tests)
2. `cd nandefact-api && npx tsc --noEmit` -- no type errors (IKudeGenerator signature change doesn't break anything since no other code calls it yet)
3. `cd nandefact-api && npx eslint src/ tests/` -- no lint errors
4. Verify packages installed: `grep "qrgen\|kude" nandefact-api/package.json` shows both TIPS-SA packages
5. Verify port updated: IKudeGenerator.generar now accepts (factura, comercio, cliente)
6. Verify stub exists: NotificadorStub.ts implements INotificador with console.log
</verification>

<success_criteria>
- facturacionelectronicapy-qrgen and facturacionelectronicapy-kude are in package.json dependencies
- IKudeGenerator port signature includes comercio and cliente parameters
- QrGeneratorSifen generates QR data with CDC + CSC hash per SIFEN spec
- KudeGeneratorImpl produces PDF Buffer using TIPS-SA kude library
- EnviarKuDE use case orchestrates: load entities -> generate PDF -> send notification
- EnviarKuDE respects cliente.enviarWhatsApp flag
- NotificadorStub logs instead of sending (placeholder for WhatsApp)
- All tests pass (0 regressions + new tests)
</success_criteria>

<output>
After completion, create `.planning/phases/04-events-kude/04-02-SUMMARY.md`
</output>
