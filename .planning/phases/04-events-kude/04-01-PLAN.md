---
phase: 04-events-kude
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - nandefact-api/src/domain/shared/types.ts
  - nandefact-api/src/domain/factura/Factura.ts
  - nandefact-api/src/domain/factura/ISifenGateway.ts
  - nandefact-api/src/application/facturacion/AnularFactura.ts
  - nandefact-api/src/application/facturacion/InutilizarNumeracion.ts
  - nandefact-api/src/infrastructure/sifen/SifenGatewayImpl.ts
  - nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts
  - nandefact-api/tests/unit/domain/factura/Factura.test.ts
  - nandefact-api/tests/unit/application/facturacion/AnularFactura.test.ts
  - nandefact-api/tests/unit/application/facturacion/InutilizarNumeracion.test.ts
  - nandefact-api/tests/unit/infrastructure/sifen/SifenGatewayImpl.test.ts
autonomous: true

must_haves:
  truths:
    - "AnularFactura mutates factura estado to 'cancelado' when SIFEN accepts cancellation"
    - "AnularFactura saves updated factura to repository after successful cancellation"
    - "AnularFactura uses proper XML via xmlgen.generateXMLEventoCancelacion instead of hardcoded XML"
    - "InutilizarNumeracion sends inutilization event to SIFEN for a given number range"
    - "InutilizarNumeracion validates range (desde <= hasta, positive numbers)"
  artifacts:
    - path: "nandefact-api/src/domain/shared/types.ts"
      provides: "EstadoSifen with 'cancelado' state"
      contains: "cancelado"
    - path: "nandefact-api/src/domain/factura/Factura.ts"
      provides: "marcarCancelada() method"
      contains: "marcarCancelada"
    - path: "nandefact-api/src/application/facturacion/InutilizarNumeracion.ts"
      provides: "Inutilization use case"
      exports: ["InutilizarNumeracion"]
    - path: "nandefact-api/src/domain/factura/ISifenGateway.ts"
      provides: "inutilizarNumeracion port method"
      contains: "inutilizarNumeracion"
  key_links:
    - from: "nandefact-api/src/application/facturacion/AnularFactura.ts"
      to: "nandefact-api/src/domain/factura/Factura.ts"
      via: "factura.marcarCancelada() call when anulada=true"
      pattern: "marcarCancelada"
    - from: "nandefact-api/src/application/facturacion/AnularFactura.ts"
      to: "nandefact-api/src/domain/factura/IFacturaRepository.ts"
      via: "facturaRepository.save(factura) after state mutation"
      pattern: "facturaRepository\\.save"
    - from: "nandefact-api/src/infrastructure/sifen/SifenGatewayImpl.ts"
      to: "facturacionelectronicapy-xmlgen"
      via: "xmlgen.generateXMLEventoCancelacion for cancellation XML"
      pattern: "generateXMLEventoCancelacion"
    - from: "nandefact-api/src/application/facturacion/InutilizarNumeracion.ts"
      to: "nandefact-api/src/domain/factura/ISifenGateway.ts"
      via: "sifenGateway.inutilizarNumeracion() call"
      pattern: "inutilizarNumeracion"
---

<objective>
Implement SIFEN events: fix cancelation to mutate state + use proper XML, and add inutilization for skipped number ranges.

Purpose: Completes FACT-04 (cancel approved DTE) and FACT-05 (inutilize skipped number ranges) requirements. AnularFactura currently has a placeholder XML and doesn't persist state changes -- this plan fixes both issues and adds the missing inutilization feature.

Output: Working cancelation with state mutation + proper XML, and new InutilizarNumeracion use case with tests.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@nandefact-api/src/domain/shared/types.ts
@nandefact-api/src/domain/factura/Factura.ts
@nandefact-api/src/domain/factura/ISifenGateway.ts
@nandefact-api/src/application/facturacion/AnularFactura.ts
@nandefact-api/src/infrastructure/sifen/SifenGatewayImpl.ts
@nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts
@nandefact-api/src/infrastructure/sifen/SifenDataMapper.ts
@nandefact-api/src/infrastructure/sifen/SifenConfig.ts
@nandefact-api/tests/unit/application/facturacion/AnularFactura.test.ts
@nandefact-api/tests/unit/infrastructure/sifen/SifenGatewayImpl.test.ts
@SIFEN_REFERENCIA_COMPLETA.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add 'cancelado' state + fix AnularFactura to mutate and persist</name>
  <files>
    nandefact-api/src/domain/shared/types.ts
    nandefact-api/src/domain/factura/Factura.ts
    nandefact-api/src/application/facturacion/AnularFactura.ts
    nandefact-api/tests/unit/domain/factura/Factura.test.ts
    nandefact-api/tests/unit/application/facturacion/AnularFactura.test.ts
  </files>
  <action>
    1. In `src/domain/shared/types.ts`, add 'cancelado' to `EstadoSifen` union type:
       ```typescript
       export type EstadoSifen = 'pendiente' | 'enviado' | 'aprobado' | 'rechazado' | 'contingencia' | 'cancelado';
       ```

    2. In `src/domain/factura/Factura.ts`, add `marcarCancelada()` method:
       - Only callable when estado === 'aprobado' (a factura must be approved before it can be cancelled)
       - Throw Error "Solo se puede cancelar una factura aprobada" if estado !== 'aprobado'
       - Sets this._estado = 'cancelado'
       - Note: validarMutable() already blocks modifications to 'aprobado' facturas, but marcarCancelada is a STATE TRANSITION not a content modification. Do NOT call validarMutable() in marcarCancelada -- the whole point is transitioning FROM aprobado.
       - Also update validarMutable() to ALSO block modifications when estado === 'cancelado' (cancelled facturas are also immutable)

    3. In `src/application/facturacion/AnularFactura.ts`, update execute():
       - After step 5 (determining anulada), add:
         - If anulada === true: call factura.marcarCancelada()
         - Then call this.deps.facturaRepository.save(factura)
       - If anulada === false (SIFEN rejected): do NOT mutate, do NOT save

    4. Update existing tests in `AnularFactura.test.ts`:
       - Test "deberia enviar evento cancelacion": verify facturaRepository.save was called, verify factura.estado === 'cancelado'
       - Test "deberia retornar anulada=false": verify facturaRepository.save was NOT called
       - Add new test: "deberia marcar factura como cancelada cuando SIFEN acepta con codigo 0261" (acceptance with observation)

    5. Add tests in `Factura.test.ts` (find existing Factura test file):
       - Test marcarCancelada() sets estado to 'cancelado' when estado is 'aprobado'
       - Test marcarCancelada() throws when estado is 'pendiente'
       - Test marcarCancelada() throws when estado is 'rechazado'
       - Test that agregarItem() throws on cancelled factura (validarMutable blocks it)
  </action>
  <verify>Run `cd nandefact-api && npx vitest run tests/unit/domain/factura/Factura.test.ts tests/unit/application/facturacion/AnularFactura.test.ts` -- all tests pass including new ones</verify>
  <done>EstadoSifen includes 'cancelado'. Factura has marcarCancelada() that only works from 'aprobado'. AnularFactura mutates and saves factura when SIFEN accepts cancellation. All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Proper XML generation for cancellation + inutilization event use case</name>
  <files>
    nandefact-api/src/domain/factura/ISifenGateway.ts
    nandefact-api/src/infrastructure/sifen/SifenGatewayImpl.ts
    nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts
    nandefact-api/src/application/facturacion/InutilizarNumeracion.ts
    nandefact-api/src/domain/comercio/IComercioRepository.ts
    nandefact-api/tests/unit/application/facturacion/InutilizarNumeracion.test.ts
    nandefact-api/tests/unit/infrastructure/sifen/SifenGatewayImpl.test.ts
  </files>
  <action>
    **Part A: Fix cancellation XML in SifenGatewayImpl**

    1. In `SifenGatewayImpl.ts`, update `anularDE()` method:
       - Remove the hardcoded XML template
       - Accept additional params: `params` (SifenParams from SifenDataMapper) for the xmlgen call
       - WAIT -- the ISifenGateway port should stay simple. Instead, update the approach:
         - Add a new method to XmlGeneratorSifen: `generarXmlEventoCancelacion(id: number, cdc: string, motivo: string, comercio: Comercio): Promise<string>`
         - This method uses `xmlgen.generateXMLEventoCancelacion(id, params, data)` where params comes from mapComercioToParams(comercio) and data contains the cancellation event info
       - Actually, re-evaluating: the simplest approach that maintains the existing architecture is to update ISifenGateway.anularDE to accept the XML evento string (already generated), rather than generating XML inside the gateway.
       - SIMPLEST APPROACH: Update SifenGatewayImpl.anularDE to receive pre-built XML (it already receives XML for enviarDE). Generate the cancellation XML in the use case layer using XmlGeneratorSifen.

       Let's go with: Keep ISifenGateway.anularDE signature accepting (cdc, motivo) BUT have SifenGatewayImpl generate proper XML internally using xmlgen. The gateway impl already has access to the library.

       In `SifenGatewayImpl.anularDE()`:
       - Replace hardcoded XML with: `const xmlgenModule = await import('facturacionelectronicapy-xmlgen');`
       - Call `xmlgenModule.default.generateXMLEventoCancelacion(1, cdc, motivo)` (check library API -- it may take different args)
       - NOTE: The xmlgen library's generateXMLEventoCancelacion takes (id, params, data) where data has the event specifics. If the library API doesn't match simple (id, cdc, motivo), build the appropriate params/data objects. Use the SifenDataMapper pattern.
       - The xmlgen library may not expose generateXMLEventoCancelacion directly. If not available, construct the XML manually following the SIFEN spec structure from section 10 of SIFEN_REFERENCIA_COMPLETA.md (the current hardcoded XML was a placeholder, replace with properly structured XML).
       - IMPORTANT: Use dynamic import (same pattern as XmlGeneratorSifen.ts) because xmlgen is CommonJS.

    **Part B: Add inutilizarNumeracion to gateway**

    2. In `ISifenGateway.ts`, add method to the port:
       ```typescript
       inutilizarNumeracion(
         establecimiento: string,
         punto: string,
         desde: number,
         hasta: number,
         motivo: string
       ): Promise<SifenResponse>;
       ```

    3. In `SifenGatewayImpl.ts`, implement `inutilizarNumeracion()`:
       - Build inutilization event XML. The SIFEN inutilization event contains:
         - Establecimiento, punto de expedicion, numero desde, numero hasta, motivo
       - Use xmlgen if it has a generateXMLEventoInutilizacion method, otherwise construct XML following SIFEN spec
       - Send via `setApi.evento()` (same endpoint as cancellation events)
       - Parse response with existing `parseEventoResponse()`

    **Part C: Create InutilizarNumeracion use case**

    4. Create `src/application/facturacion/InutilizarNumeracion.ts`:
       ```typescript
       export interface InutilizarNumeracionInput {
         comercioId: string;
         establecimiento: string;
         punto: string;
         desde: number;  // Numero inicial del rango
         hasta: number;  // Numero final del rango
         motivo: string;
       }

       export interface InutilizarNumeracionOutput {
         codigoRespuesta: string;
         mensajeRespuesta: string;
         inutilizado: boolean;
       }
       ```
       - Dependencies: ISifenGateway
       - Validate: desde > 0, hasta > 0, desde <= hasta, motivo not empty
       - Throw descriptive errors for invalid input (create inline errors or use simple Error)
       - Call sifenGateway.inutilizarNumeracion(establecimiento, punto, desde, hasta, motivo)
       - Return result with inutilizado = (codigo === '0260' || codigo === '0261')

    **Part D: Tests**

    5. Create `tests/unit/application/facturacion/InutilizarNumeracion.test.ts`:
       - Test successful inutilization (SIFEN returns 0260)
       - Test SIFEN rejects inutilization (returns 0300)
       - Test validation: desde > hasta throws error
       - Test validation: desde <= 0 throws error
       - Test validation: empty motivo throws error

    6. Update `tests/unit/infrastructure/sifen/SifenGatewayImpl.test.ts`:
       - Add mock for inutilizarNumeracion in SifenGatewayImpl
       - Verify proper XML structure or xmlgen call
       - Update existing anularDE test to verify it no longer uses hardcoded XML template

    IMPORTANT: All mocks for ISifenGateway in ALL test files must now include inutilizarNumeracion in the mock object. Check if any other test files mock ISifenGateway and update them (AnularFactura.test.ts, any in 02-* or 03-* tests).
  </action>
  <verify>Run `cd nandefact-api && npx vitest run` -- ALL 172+ tests pass (zero regressions) plus new tests. Also run `cd nandefact-api && npx tsc --noEmit` to verify type safety.</verify>
  <done>SifenGatewayImpl.anularDE uses proper XML generation (not hardcoded). ISifenGateway port has inutilizarNumeracion method. InutilizarNumeracion use case validates input and calls gateway. All tests pass including new ones and zero regressions on existing 172 tests.</done>
</task>

</tasks>

<verification>
1. `cd nandefact-api && npx vitest run` -- all tests pass (172 existing + new event tests)
2. `cd nandefact-api && npx tsc --noEmit` -- no type errors
3. `cd nandefact-api && npx eslint src/ tests/` -- no lint errors
4. Grep for hardcoded XML in SifenGatewayImpl: `grep -n "rEnvEvento" src/infrastructure/sifen/SifenGatewayImpl.ts` should return nothing (replaced with xmlgen)
5. Grep for 'cancelado' in types.ts: confirms new state exists
6. Grep for 'marcarCancelada' in Factura.ts: confirms method exists
7. Grep for 'inutilizarNumeracion' in ISifenGateway.ts: confirms port method exists
</verification>

<success_criteria>
- EstadoSifen type includes 'cancelado'
- Factura.marcarCancelada() only transitions from 'aprobado' state
- AnularFactura mutates factura to 'cancelado' and saves when SIFEN accepts
- SifenGatewayImpl.anularDE generates proper XML (not hardcoded)
- InutilizarNumeracion use case exists with input validation
- ISifenGateway port includes inutilizarNumeracion method
- All tests pass (0 regressions + new tests for events)
</success_criteria>

<output>
After completion, create `.planning/phases/04-events-kude/04-01-SUMMARY.md`
</output>
