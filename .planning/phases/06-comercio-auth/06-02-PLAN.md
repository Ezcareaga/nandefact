---
phase: 06-comercio-auth
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - nandefact-api/src/domain/usuario/Usuario.ts
  - nandefact-api/src/domain/usuario/IUsuarioRepository.ts
  - nandefact-api/src/domain/auth/IAuthService.ts
  - nandefact-api/src/domain/auth/IHashService.ts
  - nandefact-api/src/application/auth/AutenticarUsuario.ts
  - nandefact-api/src/application/auth/RefrescarToken.ts
  - nandefact-api/src/application/errors/CredencialesInvalidasError.ts
  - nandefact-api/src/application/errors/CuentaBloqueadaError.ts
  - nandefact-api/tests/unit/domain/entities/Usuario.test.ts
  - nandefact-api/tests/unit/application/auth/AutenticarUsuario.test.ts
  - nandefact-api/tests/unit/application/auth/RefrescarToken.test.ts
autonomous: true

must_haves:
  truths:
    - "User can login with telefono + PIN (4-6 digits) and receive JWT access token (15min) + refresh token (7d)"
    - "System rejects invalid PIN with clear error message"
    - "System enforces rate limiting: 5 failed PIN attempts triggers 30-minute lockout"
    - "User can refresh expired access token using valid refresh token"
    - "System tracks failed login attempts per usuario and resets on successful login"
  artifacts:
    - path: "nandefact-api/src/domain/usuario/Usuario.ts"
      provides: "Usuario entity with rol, intentos fallidos, bloqueo temporal"
    - path: "nandefact-api/src/domain/usuario/IUsuarioRepository.ts"
      provides: "Port with findByTelefono(), save()"
    - path: "nandefact-api/src/domain/auth/IAuthService.ts"
      provides: "Port for JWT token generation and validation"
    - path: "nandefact-api/src/domain/auth/IHashService.ts"
      provides: "Port for PIN hashing and verification"
    - path: "nandefact-api/src/application/auth/AutenticarUsuario.ts"
      provides: "Login use case with rate limiting logic"
    - path: "nandefact-api/src/application/auth/RefrescarToken.ts"
      provides: "Token refresh use case"
  key_links:
    - from: "AutenticarUsuario"
      to: "IUsuarioRepository"
      via: "findByTelefono() to load user, save() to update attempts"
    - from: "AutenticarUsuario"
      to: "IHashService"
      via: "verificar() to check PIN against hash"
    - from: "AutenticarUsuario"
      to: "IAuthService"
      via: "generarTokens() to create JWT pair"
    - from: "RefrescarToken"
      to: "IAuthService"
      via: "verificarRefreshToken() and generarTokens()"
---

<objective>
Implement Usuario domain entity and authentication use cases (AutenticarUsuario, RefrescarToken) with PIN-based login and rate limiting.

Purpose: Authentication gates all API access. The target user (Dona Maria) uses a simple PIN (4-6 digits) instead of complex passwords. Rate limiting protects against brute force.
Output: Usuario entity, auth ports (IAuthService, IHashService), 2 use cases with full TDD test suites.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@nandefact-api/src/domain/errors/DomainError.ts
@nandefact-api/src/application/errors/ApplicationError.ts
@nandefact-api/src/application/productos/CrearProducto.ts
@nandefact-api/src/domain/shared/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Usuario entity, IUsuarioRepository, auth ports</name>
  <files>
    nandefact-api/src/domain/usuario/Usuario.ts
    nandefact-api/src/domain/usuario/IUsuarioRepository.ts
    nandefact-api/src/domain/auth/IAuthService.ts
    nandefact-api/src/domain/auth/IHashService.ts
    nandefact-api/tests/unit/domain/entities/Usuario.test.ts
  </files>
  <action>
    1. **Add RolUsuario type** to `src/domain/shared/types.ts`:
       ```typescript
       /** Rol del usuario en el comercio */
       export type RolUsuario = 'dueño' | 'empleado';
       ```

    2. **Create Usuario entity** at `src/domain/usuario/Usuario.ts`:
       - Props interface:
         ```typescript
         export interface UsuarioProps {
           id: string;
           comercioId: string;
           nombre: string;
           telefono: string;
           pinHash: string;          // PIN hasheado (4-6 dígitos original)
           rol: RolUsuario;
           activo?: boolean;
           intentosFallidos?: number;
           bloqueadoHasta?: Date | null;
         }
         ```
       - Validations in constructor:
         - nombre cannot be empty (trim + check)
         - telefono must match `/^\+?\d{7,20}$/` (7-20 digits, optional leading +) — throw DomainError
         - pinHash cannot be empty — throw DomainError
         - rol must be 'dueño' or 'empleado' — throw DomainError
       - Readonly fields: id, comercioId, nombre, telefono, pinHash, rol, activo (default true), intentosFallidos (default 0), bloqueadoHasta (default null)
       - Methods (immutable, return new Usuario):
         - `registrarIntentoFallido(): Usuario` — increments intentosFallidos. If reaches 5, sets bloqueadoHasta to Date.now() + 30 minutes.
         - `resetearIntentos(): Usuario` — sets intentosFallidos=0, bloqueadoHasta=null
         - `estaBloqueado(ahora?: Date): boolean` — returns true if bloqueadoHasta is not null AND ahora < bloqueadoHasta. If bloqueadoHasta has passed, returns false (lockout expired).
         - `desactivar(): Usuario` — returns new Usuario with activo=false

    3. **Create IUsuarioRepository** port at `src/domain/usuario/IUsuarioRepository.ts`:
       ```typescript
       export interface IUsuarioRepository {
         save(usuario: Usuario): Promise<void>;
         findById(id: string): Promise<Usuario | null>;
         findByTelefono(telefono: string): Promise<Usuario | null>;
       }
       ```

    4. **Create IHashService** port at `src/domain/auth/IHashService.ts`:
       ```typescript
       export interface IHashService {
         /** Hash a PIN (4-6 digits) */
         hash(pin: string): Promise<string>;
         /** Verify PIN against stored hash */
         verificar(pin: string, hash: string): Promise<boolean>;
       }
       ```

    5. **Create IAuthService** port at `src/domain/auth/IAuthService.ts`:
       ```typescript
       export interface TokenPair {
         accessToken: string;
         refreshToken: string;
         expiresIn: number;  // seconds until access token expires (900 = 15min)
       }

       export interface TokenPayload {
         usuarioId: string;
         comercioId: string;
         rol: RolUsuario;
       }

       export interface IAuthService {
         /** Genera par de tokens (access 15min + refresh 7d) */
         generarTokens(payload: TokenPayload): Promise<TokenPair>;
         /** Verifica y decodifica un access token */
         verificarAccessToken(token: string): Promise<TokenPayload>;
         /** Verifica un refresh token y retorna payload */
         verificarRefreshToken(token: string): Promise<TokenPayload>;
       }
       ```

    6. **Write tests** for Usuario entity:
       - Creates with valid props (all fields assigned correctly)
       - nombre cannot be empty — throws DomainError
       - telefono must match format — throws DomainError for "abc", ""
       - Valid telefono formats: "+595981234567", "0981234567", "981234567"
       - pinHash cannot be empty — throws DomainError
       - Defaults: activo=true, intentosFallidos=0, bloqueadoHasta=null
       - `registrarIntentoFallido()` increments intentosFallidos, returns new instance
       - After 5 failed attempts, `estaBloqueado()` returns true and bloqueadoHasta is ~30min in future
       - `estaBloqueado()` returns false if bloqueadoHasta is in the past (lockout expired)
       - `resetearIntentos()` clears intentosFallidos and bloqueadoHasta
       - `desactivar()` returns new instance with activo=false
  </action>
  <verify>
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run tests/unit/domain/entities/Usuario.test.ts` — all tests pass.
    Run `npx tsc --noEmit` — no TypeScript errors.
  </verify>
  <done>
    Usuario entity with rate limiting logic (5 attempts, 30min lockout), IUsuarioRepository port, IHashService port, IAuthService port. All domain-level auth concerns are modeled as pure business logic with no infrastructure dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: AutenticarUsuario and RefrescarToken use cases</name>
  <files>
    nandefact-api/src/application/auth/AutenticarUsuario.ts
    nandefact-api/src/application/auth/RefrescarToken.ts
    nandefact-api/src/application/errors/CredencialesInvalidasError.ts
    nandefact-api/src/application/errors/CuentaBloqueadaError.ts
    nandefact-api/tests/unit/application/auth/AutenticarUsuario.test.ts
    nandefact-api/tests/unit/application/auth/RefrescarToken.test.ts
  </files>
  <action>
    1. **Create CredencialesInvalidasError** extending ApplicationError:
       ```typescript
       export class CredencialesInvalidasError extends ApplicationError {
         constructor() {
           super('Teléfono o PIN incorrecto');
         }
       }
       ```
       Note: Generic message intentionally avoids revealing which field was wrong (security best practice).

    2. **Create CuentaBloqueadaError** extending ApplicationError:
       ```typescript
       export class CuentaBloqueadaError extends ApplicationError {
         constructor(minutosRestantes: number) {
           super(`Cuenta bloqueada. Intente nuevamente en ${minutosRestantes} minutos.`);
         }
       }
       ```

    3. **Create AutenticarUsuario** use case:
       - Input DTO: `{ telefono: string, pin: string }`
       - Output DTO: `{ accessToken: string, refreshToken: string, expiresIn: number, usuario: { id: string, nombre: string, comercioId: string, rol: RolUsuario } }`
       - Dependencies: `{ usuarioRepository: IUsuarioRepository, hashService: IHashService, authService: IAuthService }`
       - Logic:
         a. Validate PIN format: must be 4-6 digits (`/^\d{4,6}$/`) — throw CredencialesInvalidasError if invalid format (don't reveal it's a format issue)
         b. Find user by telefono via `usuarioRepository.findByTelefono(input.telefono)` — throw CredencialesInvalidasError if not found (don't reveal user doesn't exist)
         c. Check if user is active (`usuario.activo`) — throw CredencialesInvalidasError if inactive
         d. Check if user is blocked: `usuario.estaBloqueado()` — throw CuentaBloqueadaError with remaining minutes
         e. Verify PIN: `hashService.verificar(input.pin, usuario.pinHash)` — if false:
            - Call `usuario.registrarIntentoFallido()` to get updated usuario
            - Save updated usuario via repository (persists attempt count)
            - Throw CredencialesInvalidasError
         f. On success:
            - Call `usuario.resetearIntentos()` to get clean usuario
            - Save updated usuario via repository (clears attempts)
            - Generate tokens via `authService.generarTokens({ usuarioId, comercioId, rol })`
            - Return output DTO with tokens + user info

    4. **Create RefrescarToken** use case:
       - Input DTO: `{ refreshToken: string }`
       - Output DTO: `{ accessToken: string, refreshToken: string, expiresIn: number }`
       - Dependencies: `{ authService: IAuthService, usuarioRepository: IUsuarioRepository }`
       - Logic:
         a. Verify refresh token via `authService.verificarRefreshToken(input.refreshToken)` — let it throw if invalid (infrastructure handles specific error)
         b. Load usuario by ID from payload — throw CredencialesInvalidasError if not found or inactive
         c. Generate new token pair via `authService.generarTokens(payload)` — full rotation (new access + new refresh)
         d. Return new tokens

    5. **Write TDD tests** for AutenticarUsuario:
       - Successful login: returns tokens + user info, resets attempts
       - Invalid telefono (user not found): throws CredencialesInvalidasError
       - Invalid PIN: throws CredencialesInvalidasError, increments attempt count, saves usuario
       - PIN format invalid (less than 4 digits, more than 6, non-numeric): throws CredencialesInvalidasError
       - Inactive user: throws CredencialesInvalidasError
       - Blocked user (5 failed attempts): throws CuentaBloqueadaError with minutes remaining
       - Blocked user with expired lockout: allows login (lockout period passed)
       - 4th failed attempt: increments but does NOT block yet
       - 5th failed attempt: blocks user for 30 minutes
       - Successful login after previous failures: resets attempt counter

    6. **Write TDD tests** for RefrescarToken:
       - Valid refresh token: returns new token pair
       - Invalid refresh token: throws (from authService)
       - User not found (deleted while token valid): throws CredencialesInvalidasError
       - Inactive user: throws CredencialesInvalidasError

    Mock all ports (IUsuarioRepository, IHashService, IAuthService) in tests following the established pattern.
    Use `.js` extensions for all imports. Follow deps injection pattern.
  </action>
  <verify>
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run tests/unit/application/auth/` — all tests pass.
    Run `npx vitest run` — ALL tests still pass (zero regressions).
    Run `npx tsc --noEmit` — no TypeScript errors.
    Run `npx eslint src/ tests/` — no ESLint errors.
  </verify>
  <done>
    AutenticarUsuario validates telefono+PIN, enforces rate limiting (5 attempts / 30min lockout), returns JWT tokens. RefrescarToken rotates token pair. Generic error messages prevent information leakage. All tests pass, zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run` — all tests pass (282 existing + new auth tests)
2. `npx tsc --noEmit` — zero TypeScript errors
3. `npx eslint src/ tests/` — zero ESLint errors
4. Usuario entity has rate limiting logic (5 attempts, 30min lockout) in domain
5. AutenticarUsuario never reveals whether telefono or PIN was wrong (security)
6. IAuthService port defines JWT lifecycle (generate, verify access, verify refresh)
7. IHashService port defines PIN hashing (implementation deferred to infrastructure)
8. Token pair includes access (15min) and refresh (7d) tokens
</verification>

<success_criteria>
- Usuario entity with login tracking (intentosFallidos, bloqueadoHasta) fully tested
- AutenticarUsuario use case with PIN validation and rate limiting
- RefrescarToken use case with token rotation
- Auth ports defined: IAuthService (JWT), IHashService (PIN hashing), IUsuarioRepository
- Application errors: CredencialesInvalidasError, CuentaBloqueadaError
- All 282+ tests pass with zero regressions
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-comercio-auth/06-02-SUMMARY.md`
</output>
