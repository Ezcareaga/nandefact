---
phase: 06-comercio-auth
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - nandefact-api/src/domain/comercio/Comercio.ts
  - nandefact-api/src/domain/comercio/IComercioRepository.ts
  - nandefact-api/src/domain/comercio/ICertificadoStore.ts
  - nandefact-api/src/application/comercio/RegistrarComercio.ts
  - nandefact-api/src/application/comercio/CargarCertificado.ts
  - nandefact-api/src/application/comercio/ConfigurarTimbrado.ts
  - nandefact-api/tests/unit/domain/entities/Comercio.test.ts
  - nandefact-api/tests/unit/application/comercio/RegistrarComercio.test.ts
  - nandefact-api/tests/unit/application/comercio/CargarCertificado.test.ts
  - nandefact-api/tests/unit/application/comercio/ConfigurarTimbrado.test.ts
autonomous: true

must_haves:
  truths:
    - "Admin can register a new comercio with RUC, razon social, establecimiento, punto expedicion and all required fields"
    - "System validates RUC uniqueness when registering comercio"
    - "Admin can upload CCFE certificate (.p12/.pfx) which gets encrypted via ICertificadoStore port before storage"
    - "Admin can update the active timbrado on an existing comercio with new vigencia dates"
    - "Comercio entity supports additional fields needed for SIFEN XML (direccion, departamento, telefono, email, actividad economica)"
  artifacts:
    - path: "nandefact-api/src/domain/comercio/Comercio.ts"
      provides: "Extended Comercio entity with full SIFEN fields, actualizar() and actualizarTimbrado() methods"
    - path: "nandefact-api/src/domain/comercio/IComercioRepository.ts"
      provides: "Extended port with save(), findByRuc() methods"
    - path: "nandefact-api/src/domain/comercio/ICertificadoStore.ts"
      provides: "Port for encrypted certificate storage (encrypt/store/retrieve)"
    - path: "nandefact-api/src/application/comercio/RegistrarComercio.ts"
      provides: "Use case for comercio registration"
    - path: "nandefact-api/src/application/comercio/CargarCertificado.ts"
      provides: "Use case for CCFE certificate upload"
    - path: "nandefact-api/src/application/comercio/ConfigurarTimbrado.ts"
      provides: "Use case for timbrado configuration"
  key_links:
    - from: "RegistrarComercio"
      to: "IComercioRepository"
      via: "save() + findByRuc() for uniqueness check"
    - from: "CargarCertificado"
      to: "ICertificadoStore"
      via: "encrypt and store certificate bytes"
    - from: "ConfigurarTimbrado"
      to: "IComercioRepository"
      via: "load comercio, update timbrado, save"
---

<objective>
Extend Comercio domain entity with full SIFEN fields and implement three comercio management use cases: RegistrarComercio, CargarCertificado, ConfigurarTimbrado.

Purpose: Comercio setup is a prerequisite for all facturacion — without a registered comercio with valid timbrado and certificate, no DE can be generated or signed.
Output: Extended Comercio entity, ICertificadoStore port, 3 use cases with full TDD test suites.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@nandefact-api/src/domain/comercio/Comercio.ts
@nandefact-api/src/domain/comercio/IComercioRepository.ts
@nandefact-api/src/domain/comercio/RUC.ts
@nandefact-api/src/domain/comercio/Timbrado.ts
@nandefact-api/src/domain/errors/DomainError.ts
@nandefact-api/src/application/errors/ApplicationError.ts
@nandefact-api/src/application/errors/ComercioNoEncontradoError.ts
@nandefact-api/src/application/productos/CrearProducto.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Comercio entity and IComercioRepository port</name>
  <files>
    nandefact-api/src/domain/comercio/Comercio.ts
    nandefact-api/src/domain/comercio/IComercioRepository.ts
    nandefact-api/src/domain/comercio/ICertificadoStore.ts
    nandefact-api/tests/unit/domain/entities/Comercio.test.ts
  </files>
  <action>
    1. **Extend ComercioProps** with optional fields from the CLAUDE.md PostgreSQL schema:
       - `direccion?: string` — dirección del comercio
       - `numeroCasa?: string` — número de casa
       - `departamento?: number` — código departamento
       - `departamentoDesc?: string` — descripción departamento
       - `distrito?: number` — código distrito
       - `distritoDesc?: string` — descripción distrito
       - `ciudad?: number` — código ciudad
       - `ciudadDesc?: string` — descripción ciudad
       - `telefono?: string` — teléfono del comercio
       - `email?: string` — email del comercio
       - `rubro?: string` — rubro comercial
       - `actividadEconomicaCodigo?: string` — código actividad económica
       - `actividadEconomicaDesc?: string` — descripción actividad
       - `tipoRegimen?: number` — tipo régimen SIFEN (8=Turismo, etc.)
       - `cscId?: string` — CSC ID for QR
       Keep existing required fields (id, ruc, razonSocial, nombreFantasia, timbrado, establecimiento, puntoExpedicion, tipoContribuyente, activo).

    2. **Add immutable update methods** to Comercio following the Producto pattern:
       - `actualizarTimbrado(nuevoTimbrado: Timbrado): Comercio` — returns new Comercio with updated timbrado. Validates timbrado is not already expired at call time via `nuevoTimbrado.estaVigente()`, throw DomainError if expired.
       - `actualizar(cambios: Partial<...>): Comercio` — partial update of mutable fields (same pattern as Producto.actualizar). id, ruc, establecimiento, puntoExpedicion should NOT be changeable.
       - `desactivar(): Comercio` — returns new Comercio with activo=false.

    3. **Extend IComercioRepository** port:
       - Add `save(comercio: Comercio): Promise<void>` — create or update
       - Add `findByRuc(ruc: string): Promise<Comercio | null>` — lookup by RUC value string
       - Keep existing `findById(id: string): Promise<Comercio | null>`

    4. **Create ICertificadoStore** port (new file):
       ```typescript
       export interface CertificadoData {
         certificado: Buffer;  // encrypted bytes
         clave: Buffer;        // encrypted key
       }

       export interface ICertificadoStore {
         /** Encripta y guarda certificado CCFE para un comercio */
         guardar(comercioId: string, certificadoPkcs12: Buffer, password: string): Promise<void>;
         /** Recupera y desencripta certificado CCFE. Null si no existe. */
         recuperar(comercioId: string): Promise<{ pkcs12: Buffer; password: string } | null>;
         /** Verifica si el comercio tiene certificado cargado */
         existe(comercioId: string): Promise<boolean>;
       }
       ```

    5. **Write tests** for Comercio entity:
       - Constructs with all required + optional fields
       - Validates establecimiento/puntoExpedicion format (existing behavior)
       - `actualizarTimbrado()` returns new instance with new timbrado
       - `actualizarTimbrado()` throws DomainError if timbrado is expired
       - `actualizar()` returns new instance with partial changes
       - `desactivar()` returns new instance with activo=false
       - Optional fields default to null when not provided
  </action>
  <verify>
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run tests/unit/domain/entities/Comercio.test.ts` — all tests pass.
    Run `npx tsc --noEmit` — no TypeScript errors.
  </verify>
  <done>
    Comercio entity has all SIFEN-required fields, immutable update methods, and ICertificadoStore port defined. All existing Comercio tests (if any) still pass. New tests cover entity updates and timbrado configuration.
  </done>
</task>

<task type="auto">
  <name>Task 2: RegistrarComercio, CargarCertificado, ConfigurarTimbrado use cases</name>
  <files>
    nandefact-api/src/application/comercio/RegistrarComercio.ts
    nandefact-api/src/application/comercio/CargarCertificado.ts
    nandefact-api/src/application/comercio/ConfigurarTimbrado.ts
    nandefact-api/src/application/errors/RucDuplicadoError.ts
    nandefact-api/tests/unit/application/comercio/RegistrarComercio.test.ts
    nandefact-api/tests/unit/application/comercio/CargarCertificado.test.ts
    nandefact-api/tests/unit/application/comercio/ConfigurarTimbrado.test.ts
  </files>
  <action>
    1. **Create RucDuplicadoError** extending ApplicationError:
       ```typescript
       export class RucDuplicadoError extends ApplicationError {
         constructor(ruc: string) {
           super(`Ya existe un comercio registrado con RUC: ${ruc}`);
         }
       }
       ```

    2. **Create RegistrarComercio** use case:
       - Input DTO: all fields for creating a Comercio (ruc as string, razonSocial, nombreFantasia, timbrado data {numero, fechaInicio, fechaFin}, establecimiento, puntoExpedicion, tipoContribuyente, plus optional SIFEN fields)
       - Output DTO: `{ comercioId: string }`
       - Dependencies: `{ comercioRepository: IComercioRepository }`
       - Logic:
         a. Check RUC uniqueness via `comercioRepository.findByRuc(input.ruc)` — throw RucDuplicadoError if exists
         b. Create RUC value object from input string (domain validates format + DV)
         c. Create Timbrado value object from input dates
         d. Validate timbrado is currently vigente — throw DomainError if expired
         e. Generate UUID for comercioId
         f. Create Comercio entity (domain validates all fields)
         g. Save via repository
         h. Return comercioId

    3. **Create CargarCertificado** use case:
       - Input DTO: `{ comercioId: string, certificadoPkcs12: Buffer, password: string }`
       - Output: void
       - Dependencies: `{ comercioRepository: IComercioRepository, certificadoStore: ICertificadoStore }`
       - Logic:
         a. Verify comercio exists via `comercioRepository.findById()` — throw ComercioNoEncontradoError if not
         b. Validate certificado is not empty (Buffer.length > 0) — throw ApplicationError if empty
         c. Validate password is not empty — throw ApplicationError if empty
         d. Store via `certificadoStore.guardar(comercioId, certificadoPkcs12, password)`

    4. **Create ConfigurarTimbrado** use case:
       - Input DTO: `{ comercioId: string, timbradoNumero: string, fechaInicio: Date, fechaFin: Date }`
       - Output: void
       - Dependencies: `{ comercioRepository: IComercioRepository }`
       - Logic:
         a. Load comercio via `comercioRepository.findById()` — throw ComercioNoEncontradoError if not
         b. Create new Timbrado value object (validates format + date range)
         c. Call `comercio.actualizarTimbrado(nuevoTimbrado)` — returns new Comercio (validates vigencia)
         d. Save updated comercio via `comercioRepository.save()`

    5. **Write TDD tests** following the pattern in CrearProducto.test.ts:
       - RegistrarComercio: creates comercio with valid data, throws on duplicate RUC, throws on invalid RUC, throws on expired timbrado, generates UUID, saves via repo
       - CargarCertificado: stores cert for existing comercio, throws if comercio not found, throws if cert is empty, throws if password empty
       - ConfigurarTimbrado: updates timbrado on existing comercio, throws if comercio not found, throws if timbrado expired, saves updated comercio via repo

    Follow the deps injection pattern: `constructor(private readonly deps: { ... })`.
    Use `randomUUID` from crypto for ID generation.
    All import paths use `.js` extensions (ESM project convention).
  </action>
  <verify>
    Run `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run tests/unit/application/comercio/` — all tests pass.
    Run `npx vitest run` — ALL 282+ tests still pass (zero regressions).
    Run `npx tsc --noEmit` — no TypeScript errors.
  </verify>
  <done>
    Three comercio management use cases implemented with TDD. RegistrarComercio validates RUC uniqueness. CargarCertificado delegates encryption to ICertificadoStore port. ConfigurarTimbrado uses Comercio.actualizarTimbrado() immutable method. All tests pass, zero regressions.
  </done>
</task>

</tasks>

<verification>
1. `cd /home/ez/projects/nandefact/nandefact-api && npx vitest run` — all tests pass (282 existing + new comercio tests)
2. `npx tsc --noEmit` — zero TypeScript errors
3. `npx eslint src/ tests/` — zero ESLint errors
4. Comercio entity has all fields needed for SIFEN XML generation (Group B: Emisor)
5. IComercioRepository has save() and findByRuc() methods
6. ICertificadoStore port is defined (implementation deferred to infrastructure phase)
7. No existing use case tests broken by Comercio entity changes
</verification>

<success_criteria>
- 3 new use cases (RegistrarComercio, CargarCertificado, ConfigurarTimbrado) fully tested
- Comercio entity extended with SIFEN fields + immutable update methods
- ICertificadoStore port defined for encrypted certificate management
- IComercioRepository extended with save() and findByRuc()
- All 282+ tests pass with zero regressions
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/06-comercio-auth/06-01-SUMMARY.md`
</output>
