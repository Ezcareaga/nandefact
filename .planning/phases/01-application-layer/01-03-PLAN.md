---
phase: 01-application-layer
plan: 03
type: tdd
wave: 2
depends_on: ["01-02"]
files_modified:
  - nandefact-api/src/application/sync/SincronizarPendientes.ts
  - nandefact-api/tests/unit/application/sync/SincronizarPendientes.test.ts
autonomous: true

must_haves:
  truths:
    - "SincronizarPendientes loads all pending facturas for a comercio and processes them in FIFO order (oldest first)"
    - "SincronizarPendientes continues processing remaining facturas even if one fails"
    - "SincronizarPendientes returns a summary with processed count, success count, and failed count with error details"
    - "Each pending factura goes through the same sign-send-update flow as EnviarDE"
  artifacts:
    - path: "nandefact-api/src/application/sync/SincronizarPendientes.ts"
      provides: "SincronizarPendientes use case class"
      exports: ["SincronizarPendientes", "SincronizarPendientesInput", "SincronizarPendientesOutput", "ResultadoFactura"]
    - path: "nandefact-api/tests/unit/application/sync/SincronizarPendientes.test.ts"
      provides: "Unit tests for SincronizarPendientes"
      min_lines: 80
  key_links:
    - from: "nandefact-api/src/application/sync/SincronizarPendientes.ts"
      to: "IFacturaRepository"
      via: "loads pending facturas via findPendientes, saves each after processing"
      pattern: "facturaRepository\\.findPendientes"
    - from: "nandefact-api/src/application/sync/SincronizarPendientes.ts"
      to: "ISifenGateway + IFirmaDigital"
      via: "signs and sends each factura to SIFEN"
      pattern: "(firmaDigital\\.firmar|sifenGateway\\.enviarDE)"
---

<objective>
Implement the SincronizarPendientes use case — offline queue processing that syncs pending facturas with SIFEN.

Purpose: This is the queue engine that processes facturas created while offline. It loads all pending facturas for a comercio and sends each to SIFEN in FIFO order, continuing even if individual facturas fail. This is critical for the offline-first architecture where Doña María creates facturas without internet and they sync later.

Output: Working SincronizarPendientes use case with TDD tests covering FIFO order, error resilience, and result reporting.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md

# Domain entities and ports
@nandefact-api/src/domain/factura/Factura.ts
@nandefact-api/src/domain/factura/IFacturaRepository.ts
@nandefact-api/src/domain/factura/ISifenGateway.ts
@nandefact-api/src/domain/factura/IFirmaDigital.ts
@nandefact-api/src/domain/shared/types.ts

# EnviarDE use case (created by Plan 02) — SincronizarPendientes reuses the same sign-send pattern
# Read Plan 02 SUMMARY if it exists: @.planning/phases/01-application-layer/01-02-SUMMARY.md
# If Plan 02 hasn't run, read: @nandefact-api/src/application/facturacion/EnviarDE.ts

# Application errors (from Plan 01)
# Read: @nandefact-api/src/application/errors/ApplicationError.ts

# Test conventions
@nandefact-api/tests/unit/domain/entities/Factura.test.ts
@nandefact-api/vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED — Write failing tests for SincronizarPendientes</name>
  <files>
    nandefact-api/tests/unit/application/sync/SincronizarPendientes.test.ts
  </files>
  <action>
    Create test file `tests/unit/application/sync/SincronizarPendientes.test.ts`.

    **Test setup:**
    - Helper function to create a Factura in 'pendiente' state WITH items and CDC:
      ```typescript
      function crearFacturaPendiente(id: string, fecha: Date): Factura {
        const timbrado = new Timbrado('12558946', new Date('2024-01-01'), new Date('2025-12-31'));
        const nf = new NumeroFactura('001', '003', id.padStart(7, '0'));
        const factura = new Factura({
          id,
          comercioId: 'comercio-1',
          clienteId: 'cliente-1',
          tipoDocumento: 1,
          timbrado,
          numeroFactura: nf,
          tipoEmision: 1,
          condicionPago: 'contado',
          fechaEmision: fecha,
        });
        factura.agregarItem(new ItemFactura({
          descripcion: 'Producto test',
          cantidad: 1,
          precioUnitario: 10000,
          tasaIVA: 10,
        }));
        factura.generarCDC(new RUC('80069563-1'), 1);
        return factura;
      }
      ```
    - Mock IFacturaRepository, IFirmaDigital, ISifenGateway
    - For FIFO order tests: create facturas with different dates and return them from findPendientes in chronological order

    **SincronizarPendientesInput:** `{ comercioId: string }`
    **SincronizarPendientesOutput:**
    ```typescript
    {
      totalProcesadas: number;
      exitosas: number;
      fallidas: number;
      resultados: ResultadoFactura[];
    }
    ```
    **ResultadoFactura:** `{ facturaId: string, cdc: string, exito: boolean, error?: string }`

    **Test cases:**
    1. `debería procesar todas las facturas pendientes en orden FIFO` — 3 facturas with dates Jan, Feb, Mar. Mock enviarDE returns 0260 for all. Assert: enviarDE called 3 times, in order of facturaId (which maps to date order). Assert: output.totalProcesadas=3, exitosas=3, fallidas=0.

    2. `debería continuar procesando si una factura falla` — 3 facturas, mock enviarDE to throw Error on the 2nd call but succeed on 1st and 3rd. Assert: output.totalProcesadas=3, exitosas=2, fallidas=1. Assert: resultados[1].exito=false, resultados[1].error contains something.

    3. `debería retornar resultado vacío si no hay pendientes` — findPendientes returns []. Assert: output.totalProcesadas=0, exitosas=0, fallidas=0, resultados=[].

    4. `debería firmar y enviar cada factura individualmente` — 2 facturas. Assert: firmaDigital.firmar called 2 times, sifenGateway.enviarDE called 2 times.

    5. `debería guardar cada factura después de procesarla` — 2 facturas, both succeed. Assert: facturaRepository.save called 2 times.

    6. `debería marcar factura como rechazada si SIFEN devuelve error` — 1 factura, mock enviarDE returns { codigo: '0300', mensaje: 'Rechazo' }. Assert: save called with factura in 'rechazado' state. Assert: output.exitosas=0, fallidas=0 (rejected is not a failure — it's a valid SIFEN response). Wait, reconsider: a SIFEN rejection (0300) is a "successful communication with a negative result". An error (network timeout, exception) is a "failure". Distinguish:
      - SIFEN response with code 0260/0261 → exitosa, estado=aprobado
      - SIFEN response with code 0300+ → exitosa (communication worked), but factura rechazada. Count in exitosas or have separate category? For simplicity: count in exitosas (the sync worked), but the factura is marked rechazado. ResultadoFactura.exito=true for both approved and rejected (the sync succeeded). Only exito=false when there's an exception/network error.

    Revise test case 6: `debería marcar factura como rechazada cuando SIFEN rechaza (0300)` — 1 factura, enviarDE returns { codigo: '0300' }. Assert: factura saved with estado 'rechazado', output.exitosas=1, output.resultados[0].exito=true.

    All tests should FAIL because SincronizarPendientes.ts doesn't exist.
  </action>
  <verify>Run `cd nandefact-api && npx vitest run tests/unit/application/sync/SincronizarPendientes.test.ts` — ALL 6 tests FAIL (module not found). Existing tests still pass: `npx vitest run tests/unit/domain/`.</verify>
  <done>6 test cases for SincronizarPendientes. All fail. No regression in existing tests.</done>
</task>

<task type="auto">
  <name>Task 2: GREEN — Implement SincronizarPendientes to pass all tests</name>
  <files>
    nandefact-api/src/application/sync/SincronizarPendientes.ts
  </files>
  <action>
    Create `src/application/sync/SincronizarPendientes.ts`:

    **Exports:**
    - `SincronizarPendientesInput` type
    - `SincronizarPendientesOutput` type
    - `ResultadoFactura` type
    - `SincronizarPendientes` class

    **SincronizarPendientes class:**
    - Constructor: `{ facturaRepository: IFacturaRepository, firmaDigital: IFirmaDigital, sifenGateway: ISifenGateway }`
    - `async execute(input: SincronizarPendientesInput): Promise<SincronizarPendientesOutput>`

    **execute() flow:**
    1. Load pending: `await this.facturaRepository.findPendientes(input.comercioId)`
    2. Sort by fechaEmision ascending (FIFO — oldest first). findPendientes might already return sorted, but sort explicitly to guarantee FIFO.
    3. Initialize counters: totalProcesadas=0, exitosas=0, fallidas=0, resultados=[]
    4. For each factura (sequential, NOT parallel — SIFEN requires ordered processing):
       a. totalProcesadas++
       b. Try:
          - Generate placeholder XML: `<DE><CDC>${factura.cdc!.value}</CDC></DE>`
          - Sign: `await firmaDigital.firmar(xml)`
          - Send: `await sifenGateway.enviarDE(xmlFirmado)`
          - Update state: 0260/0261 → marcarAprobada(), else → marcarRechazada()
          - IMPORTANT: Call marcarEnviada() BEFORE sending, to record the attempt
          - Save: `await facturaRepository.save(factura)`
          - exitosas++
          - Push ResultadoFactura { facturaId, cdc, exito: true }
       c. Catch (error):
          - fallidas++
          - Push ResultadoFactura { facturaId, cdc, exito: false, error: error.message }
          - Continue to next factura (do NOT break)
    5. Return SincronizarPendientesOutput

    **Key design decisions:**
    - Sequential processing (not Promise.all) — SIFEN processes in order, network errors should not skip facturas
    - Error in one factura does NOT stop queue — critical for offline-first reliability
    - SIFEN rejection (0300) is NOT a failure — it's a valid response. The factura is marked 'rechazado' and the sync continues.
    - Placeholder XML will be replaced when SIFEN XML generation is implemented in Phase 2

    Remove `.gitkeep` from `src/application/sync/` if it exists.
    Use relative imports with `.js` extensions.
  </action>
  <verify>Run `cd nandefact-api && npx vitest run tests/unit/application/sync/SincronizarPendientes.test.ts` — ALL 6 tests pass. Run `npx vitest run` — ALL tests pass (no regressions). Run `npx tsc --noEmit` — compiles.</verify>
  <done>SincronizarPendientes processes pending facturas in FIFO order, continues on failure, reports detailed results. 6 tests pass. No regressions. TypeScript compiles.</done>
</task>

</tasks>

<verification>
1. `cd nandefact-api && npx tsc --noEmit` — zero TypeScript errors
2. `cd nandefact-api && npx vitest run` — all tests passing (previous tests + 6 new)
3. SincronizarPendientes exists at `src/application/sync/SincronizarPendientes.ts`
4. FIFO order verified by test
5. Error resilience verified by test (continues after failure)
6. No `.gitkeep` files in `src/application/sync/`
</verification>

<success_criteria>
- SincronizarPendientes processes pending facturas FIFO, continues on failure, reports results
- 6 new tests pass
- No regressions in all existing tests
- TypeScript strict mode compiles clean
- Use case follows same constructor injection pattern as CrearFactura and EnviarDE
</success_criteria>

<output>
After completion, create `.planning/phases/01-application-layer/01-03-SUMMARY.md`
</output>
