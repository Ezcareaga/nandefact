---
phase: 02-sifen-integration
plan: 03
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - nandefact-api/src/application/facturacion/EnviarDE.ts
  - nandefact-api/src/application/sync/SincronizarPendientes.ts
  - nandefact-api/tests/unit/application/facturacion/EnviarDE.test.ts
  - nandefact-api/tests/unit/application/sync/SincronizarPendientes.test.ts
  - nandefact-api/src/domain/cliente/IClienteRepository.ts
autonomous: true

must_haves:
  truths:
    - "EnviarDE use case generates real SIFEN XML instead of placeholder"
    - "EnviarDE loads Comercio and Cliente data to pass to XML generator"
    - "SincronizarPendientes use case generates real SIFEN XML for each pending factura"
    - "System can load client data needed for XML receptor section"
    - "All existing application tests still pass with updated dependencies"
  artifacts:
    - path: "nandefact-api/src/application/facturacion/EnviarDE.ts"
      provides: "Updated use case with IXmlGenerator dependency"
      contains: "xmlGenerator"
    - path: "nandefact-api/src/application/sync/SincronizarPendientes.ts"
      provides: "Updated use case with IXmlGenerator dependency"
      contains: "xmlGenerator"
    - path: "nandefact-api/src/domain/cliente/IClienteRepository.ts"
      provides: "Client repository port"
      contains: "IClienteRepository"
    - path: "nandefact-api/tests/unit/application/facturacion/EnviarDE.test.ts"
      provides: "Updated tests with new dependencies"
      contains: "xmlGenerator"
  key_links:
    - from: "nandefact-api/src/application/facturacion/EnviarDE.ts"
      to: "nandefact-api/src/domain/factura/IXmlGenerator.ts"
      via: "dependency injection"
      pattern: "xmlGenerator.*IXmlGenerator"
    - from: "nandefact-api/src/application/facturacion/EnviarDE.ts"
      to: "nandefact-api/src/domain/comercio/IComercioRepository.ts"
      via: "dependency injection"
      pattern: "comercioRepository.*IComercioRepository"
    - from: "nandefact-api/src/application/facturacion/EnviarDE.ts"
      to: "nandefact-api/src/domain/cliente/IClienteRepository.ts"
      via: "dependency injection"
      pattern: "clienteRepository.*IClienteRepository"
---

<objective>
Wire the new IXmlGenerator, IComercioRepository, and IClienteRepository ports into the EnviarDE and SincronizarPendientes use cases, replacing the placeholder XML generation with real SIFEN XML generation. Create the missing IClienteRepository port.

Purpose: This plan completes the Phase 2 integration by connecting the infrastructure adapters (from plans 02-01 and 02-02) to the application use cases (from Phase 1). After this plan, the system can generate real SIFEN-compliant XML from domain entities instead of placeholder XML. The full chain becomes: load factura + comercio + cliente -> generate XML -> sign -> send to SIFEN.

Output: Updated EnviarDE and SincronizarPendientes with real XML generation, IClienteRepository port, updated tests.

NOTE: IComercioRepository and IClienteRepository implementations (PostgreSQL adapters) are deferred to later phases (Phase 3+). Phase 2 verification is unit-test-level only, using mock implementations of these repositories. The ports are defined here; their persistence adapters will be built when the infrastructure/persistence layer is implemented.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-application-layer/01-02-SUMMARY.md
@.planning/phases/01-application-layer/01-03-SUMMARY.md

# Use cases to modify:
@nandefact-api/src/application/facturacion/EnviarDE.ts
@nandefact-api/src/application/sync/SincronizarPendientes.ts

# Existing tests to update:
@nandefact-api/tests/unit/application/facturacion/EnviarDE.test.ts
@nandefact-api/tests/unit/application/sync/SincronizarPendientes.test.ts

# Domain ports:
@nandefact-api/src/domain/factura/IXmlGenerator.ts
@nandefact-api/src/domain/comercio/IComercioRepository.ts
@nandefact-api/src/domain/factura/IFacturaRepository.ts
@nandefact-api/src/domain/factura/IFirmaDigital.ts
@nandefact-api/src/domain/factura/ISifenGateway.ts

# Domain entities needed for wiring:
@nandefact-api/src/domain/factura/Factura.ts
@nandefact-api/src/domain/comercio/Comercio.ts
@nandefact-api/src/domain/cliente/Cliente.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create IClienteRepository port + Update EnviarDE with real XML generation</name>
  <files>
    nandefact-api/src/domain/cliente/IClienteRepository.ts
    nandefact-api/src/application/facturacion/EnviarDE.ts
    nandefact-api/tests/unit/application/facturacion/EnviarDE.test.ts
  </files>
  <action>
**Step 1: Create IClienteRepository port** in `src/domain/cliente/IClienteRepository.ts`:

```typescript
import type { Cliente } from './Cliente.js';

/** Puerto — Persistencia de clientes */
export interface IClienteRepository {
  save(cliente: Cliente): Promise<void>;
  findById(id: string): Promise<Cliente | null>;
  findByComercio(comercioId: string): Promise<Cliente[]>;
  buscar(comercioId: string, query: string): Promise<Cliente[]>;
}
```

**Step 2: Update EnviarDE use case** — Replace placeholder XML with real XML generation:

The updated EnviarDE needs three new dependencies:
- `IXmlGenerator` — to generate real SIFEN XML
- `IComercioRepository` — to load comercio data (needed for XML emisor section)
- `IClienteRepository` — to load cliente data (needed for XML receptor section)

Changes to EnviarDE.ts:

1. Add new imports:
```typescript
import type { IXmlGenerator } from '../../domain/factura/IXmlGenerator.js';
import type { IComercioRepository } from '../../domain/comercio/IComercioRepository.js';
import type { IClienteRepository } from '../../domain/cliente/IClienteRepository.js';
```

2. Update constructor deps:
```typescript
constructor(
  private readonly deps: {
    facturaRepository: IFacturaRepository;
    firmaDigital: IFirmaDigital;
    sifenGateway: ISifenGateway;
    xmlGenerator: IXmlGenerator;
    comercioRepository: IComercioRepository;
    clienteRepository: IClienteRepository;
  },
) {}
```

3. Update execute() method — replace `generarXmlPlaceholder()` with real XML generation:

```typescript
async execute(input: EnviarDEInput): Promise<EnviarDEOutput> {
  // 1. Cargar factura
  const factura = await this.deps.facturaRepository.findById(input.facturaId);
  if (!factura) {
    throw new FacturaNoEncontradaError(input.facturaId);
  }

  // 2. Cargar comercio (necesario para XML emisor)
  const comercio = await this.deps.comercioRepository.findById(factura.comercioId);
  if (!comercio) {
    throw new ComercioNoEncontradoError(factura.comercioId);
  }

  // 3. Cargar cliente (necesario para XML receptor)
  const cliente = await this.deps.clienteRepository.findById(factura.clienteId);
  if (!cliente) {
    throw new Error(`Cliente ${factura.clienteId} no encontrado`);
  }

  // 4. Marcar como enviada (registra el intento)
  factura.marcarEnviada();

  // 5. Generar XML del Documento Electrónico
  if (!factura.cdc) {
    throw new Error(`Factura ${input.facturaId} no tiene CDC generado`);
  }
  const xmlDE = await this.deps.xmlGenerator.generarXml(factura, comercio, cliente);

  // 6. Firmar XML con certificado CCFE
  const xmlFirmado = await this.deps.firmaDigital.firmar(xmlDE);

  // 7. Enviar a SIFEN
  const response = await this.deps.sifenGateway.enviarDE(xmlFirmado);

  // 8. Actualizar estado según respuesta SIFEN
  const esAprobado = response.codigo === '0260' || response.codigo === '0261';
  if (esAprobado) {
    factura.marcarAprobada();
  } else {
    factura.marcarRechazada();
  }

  // 9. Persistir factura con estado actualizado
  await this.deps.facturaRepository.save(factura);

  // 10. Retornar resultado
  return {
    cdc: response.cdc,
    estadoSifen: factura.estado,
    codigoRespuesta: response.codigo,
    mensajeRespuesta: response.mensaje,
  };
}
```

4. REMOVE the `generarXmlPlaceholder()` private method entirely.
5. Add import for ComercioNoEncontradoError (already exists from Phase 1).

**Step 3: Update EnviarDE tests** — Add mock IXmlGenerator, IComercioRepository, IClienteRepository:

The test file already has mocks for facturaRepository, firmaDigital, sifenGateway. Add:

```typescript
// Nuevos mocks
const mockXmlGenerator: IXmlGenerator = {
  generarXml: vi.fn().mockResolvedValue('<DE><rDE>...</rDE></DE>'),
};

const mockComercioRepository: IComercioRepository = {
  findById: vi.fn().mockResolvedValue(comercioTest),  // Create a test comercio
  save: vi.fn(),
};

const mockClienteRepository: IClienteRepository = {
  findById: vi.fn().mockResolvedValue(clienteTest),  // Create a test cliente
  save: vi.fn(),
  findByComercio: vi.fn().mockResolvedValue([]),
  buscar: vi.fn().mockResolvedValue([]),
};
```

Create helper test entities `comercioTest` and `clienteTest` using the domain constructors with realistic test data.

Update the EnviarDE constructor call in tests to include the new deps.

Update existing test cases to verify:
- xmlGenerator.generarXml is called with (factura, comercio, cliente)
- comercioRepository.findById is called with factura.comercioId
- clienteRepository.findById is called with factura.clienteId

Add new test cases:
- "debe lanzar error si comercio no encontrado" — Mock comercioRepository.findById returns null
- "debe lanzar error si cliente no encontrado" — Mock clienteRepository.findById returns null
- "debe llamar a xmlGenerator.generarXml con factura, comercio y cliente" — Verify call args

Run tests and verify all EnviarDE tests pass.

Commit: `feat(02-03): wire IXmlGenerator into EnviarDE, replace placeholder XML`
  </action>
  <verify>
Run `cd nandefact-api && npx vitest run tests/unit/application/facturacion/EnviarDE.test.ts` and verify ALL tests pass. Verify the `generarXmlPlaceholder` method no longer exists in EnviarDE.ts with `grep -c "generarXmlPlaceholder" nandefact-api/src/application/facturacion/EnviarDE.ts` returning 0.
  </verify>
  <done>
IClienteRepository port exists in domain/cliente/. EnviarDE now loads comercio + cliente data and generates real XML via IXmlGenerator instead of placeholder. All existing EnviarDE tests updated and passing. New tests for comercio/cliente not found scenarios added and passing.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update SincronizarPendientes with real XML generation + final verification</name>
  <files>
    nandefact-api/src/application/sync/SincronizarPendientes.ts
    nandefact-api/tests/unit/application/sync/SincronizarPendientes.test.ts
  </files>
  <action>
**Step 1: Update SincronizarPendientes use case** — Same pattern as EnviarDE:

1. Add new imports: IXmlGenerator, IComercioRepository, IClienteRepository
2. Update constructor deps to include the three new dependencies
3. Update `procesarFactura()` private method:
   - Load comercio via `this.deps.comercioRepository.findById(factura.comercioId)`
   - Load cliente via `this.deps.clienteRepository.findById(factura.clienteId)`
   - Replace `generarXmlPlaceholder(factura.cdc.value)` with `this.deps.xmlGenerator.generarXml(factura, comercio, cliente)`
   - Handle comercio/cliente not found as errors (catch block already handles exceptions)
4. REMOVE the `generarXmlPlaceholder()` private method entirely.

Updated `procesarFactura()`:
```typescript
private async procesarFactura(factura: Factura): Promise<void> {
  // 1. Marcar como enviada
  factura.marcarEnviada();

  // 2. Cargar comercio y cliente para generación XML
  const comercio = await this.deps.comercioRepository.findById(factura.comercioId);
  if (!comercio) {
    throw new Error(`Comercio ${factura.comercioId} no encontrado`);
  }
  const cliente = await this.deps.clienteRepository.findById(factura.clienteId);
  if (!cliente) {
    throw new Error(`Cliente ${factura.clienteId} no encontrado`);
  }

  // 3. Generar XML del DE
  if (!factura.cdc) {
    throw new Error(`Factura ${factura.id} no tiene CDC generado`);
  }
  const xmlDE = await this.deps.xmlGenerator.generarXml(factura, comercio, cliente);

  // 4. Firmar XML con certificado CCFE
  const xmlFirmado = await this.deps.firmaDigital.firmar(xmlDE);

  // 5. Enviar a SIFEN
  const response = await this.deps.sifenGateway.enviarDE(xmlFirmado);

  // 6. Actualizar estado
  const esAprobado = response.codigo === '0260' || response.codigo === '0261';
  if (esAprobado) {
    factura.marcarAprobada();
  } else {
    factura.marcarRechazada();
  }

  // 7. Persistir
  await this.deps.facturaRepository.save(factura);
}
```

**Step 2: Update SincronizarPendientes tests** — Same pattern as EnviarDE test updates:

Add mockXmlGenerator, mockComercioRepository, mockClienteRepository with test data.

Create test comercio and cliente entities. All facturas in the test use the same comercioId and clienteId, so mocks return the same test entities.

Update constructor call to include new deps.

Verify existing test behavior is preserved:
- FIFO ordering still works
- Continue-on-failure still works
- Success/failure counting still works

Add new test case:
- "debe llamar a xmlGenerator para cada factura pendiente" — With 3 pendientes, xmlGenerator.generarXml should be called 3 times

**Step 3: Run ALL tests** to ensure zero regressions:

```bash
cd nandefact-api && npx vitest run
```

ALL tests must pass: 81 existing (some modified) + new tests from plans 02-01 and 02-02.

**Step 4: TypeScript compilation check:**

```bash
cd nandefact-api && npx tsc --noEmit
```

Must compile without errors.

Commit: `feat(02-03): wire IXmlGenerator into SincronizarPendientes, complete Phase 2 wiring`
  </action>
  <verify>
Run `cd nandefact-api && npx vitest run` and verify ALL tests pass (zero regressions). Run `npx tsc --noEmit` for clean compilation. Run `grep -c "generarXmlPlaceholder" nandefact-api/src/application/sync/SincronizarPendientes.ts` returning 0 (placeholder removed). Run `grep -c "generarXmlPlaceholder" nandefact-api/src/application/facturacion/EnviarDE.ts` returning 0.
  </verify>
  <done>
SincronizarPendientes now generates real XML via IXmlGenerator for each pending factura. All placeholder XML generation removed from the codebase. All tests pass. TypeScript compiles clean. Phase 2 infrastructure adapters are fully wired into application use cases.
  </done>
</task>

</tasks>

<verification>
1. `cd nandefact-api && npx vitest run` — ALL tests pass (zero regressions, ~100+ total)
2. `npx tsc --noEmit` — TypeScript compiles clean
3. `grep -rc "generarXmlPlaceholder" nandefact-api/src/` — Returns 0 (all placeholders removed)
4. `grep "xmlGenerator" nandefact-api/src/application/facturacion/EnviarDE.ts` — xmlGenerator is injected
5. `grep "xmlGenerator" nandefact-api/src/application/sync/SincronizarPendientes.ts` — xmlGenerator is injected
6. `grep "comercioRepository" nandefact-api/src/application/facturacion/EnviarDE.ts` — comercioRepository injected
7. `grep "clienteRepository" nandefact-api/src/application/facturacion/EnviarDE.ts` — clienteRepository injected
8. `test -f nandefact-api/src/domain/cliente/IClienteRepository.ts` — Port exists
</verification>

<success_criteria>
- EnviarDE loads Comercio + Cliente + Factura and generates real XML via IXmlGenerator port
- SincronizarPendientes does the same for each pending factura
- All placeholder XML generation is removed from the codebase
- IClienteRepository port is defined in domain layer
- All tests pass with the new dependencies injected as mocks
- Zero test regressions from Phase 1
- TypeScript compiles clean
</success_criteria>

<output>
After completion, create `.planning/phases/02-sifen-integration/02-03-SUMMARY.md`
</output>
