---
phase: 02-sifen-integration
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - nandefact-api/src/domain/factura/IXmlGenerator.ts
  - nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts
  - nandefact-api/src/infrastructure/sifen/SifenDataMapper.ts
  - nandefact-api/tests/unit/infrastructure/sifen/XmlGeneratorSifen.test.ts
  - nandefact-api/tests/unit/infrastructure/sifen/SifenDataMapper.test.ts
  - nandefact-api/package.json
autonomous: true

must_haves:
  truths:
    - "System can map a Factura + Comercio + Cliente to TIPS-SA xmlgen params/data format"
    - "System generates XML DE string via facturacionelectronicapy-xmlgen library"
    - "Generated XML contains correct CDC, timbrado, emisor, receptor, items, and totales"
    - "System generates XML that follows SIFEN v150 structure with all required groups (emisor, receptor, items, totales)"
  artifacts:
    - path: "nandefact-api/src/domain/factura/IXmlGenerator.ts"
      provides: "IXmlGenerator port interface"
      contains: "generarXml"
    - path: "nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts"
      provides: "SIFEN XML generation adapter"
      contains: "facturacionelectronicapy-xmlgen"
    - path: "nandefact-api/src/infrastructure/sifen/SifenDataMapper.ts"
      provides: "Domain-to-TIPS-SA mapping functions"
      contains: "mapComercioToParams"
    - path: "nandefact-api/tests/unit/infrastructure/sifen/SifenDataMapper.test.ts"
      provides: "Unit tests for data mapping"
      min_lines: 50
  key_links:
    - from: "nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts"
      to: "nandefact-api/src/domain/factura/IXmlGenerator.ts"
      via: "implements IXmlGenerator"
      pattern: "implements IXmlGenerator"
    - from: "nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts"
      to: "facturacionelectronicapy-xmlgen"
      via: "import xmlgen"
      pattern: "facturacionelectronicapy-xmlgen"
    - from: "nandefact-api/src/infrastructure/sifen/SifenDataMapper.ts"
      to: "nandefact-api/src/domain/comercio/Comercio.ts"
      via: "import Comercio"
      pattern: "import.*Comercio"
---

<objective>
Create the IXmlGenerator domain port and its SIFEN implementation that maps domain entities (Factura, Comercio, Cliente) to the TIPS-SA xmlgen library format, generating valid SIFEN XML DE documents.

Purpose: XML generation is the core of SIFEN integration. The EnviarDE use case currently uses a placeholder `<DE><CDC>...</CDC></DE>`. This plan creates the real XML generator that produces SIFEN v150-compliant XML from domain entities, using the `facturacionelectronicapy-xmlgen` npm library.

Output: IXmlGenerator port in domain, SifenDataMapper (pure functions mapping domain -> TIPS-SA format), XmlGeneratorSifen adapter class, and TDD tests proving correct mapping.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-application-layer/01-02-SUMMARY.md

# Domain entities the mapper needs to understand:
@nandefact-api/src/domain/factura/Factura.ts
@nandefact-api/src/domain/factura/ItemFactura.ts
@nandefact-api/src/domain/factura/MontoIVA.ts
@nandefact-api/src/domain/factura/CDC.ts
@nandefact-api/src/domain/factura/NumeroFactura.ts
@nandefact-api/src/domain/comercio/Comercio.ts
@nandefact-api/src/domain/comercio/RUC.ts
@nandefact-api/src/domain/comercio/Timbrado.ts
@nandefact-api/src/domain/cliente/Cliente.ts
@nandefact-api/src/domain/shared/types.ts

# Package config:
@nandefact-api/package.json
@nandefact-api/tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install xmlgen + Create IXmlGenerator port + SifenDataMapper with TDD (RED)</name>
  <files>
    nandefact-api/package.json
    nandefact-api/src/domain/factura/IXmlGenerator.ts
    nandefact-api/src/infrastructure/sifen/SifenDataMapper.ts
    nandefact-api/tests/unit/infrastructure/sifen/SifenDataMapper.test.ts
  </files>
  <action>
**Step 1: Install dependency**

```bash
cd nandefact-api && npm install facturacionelectronicapy-xmlgen
```

**Step 2: Create IXmlGenerator port** in `src/domain/factura/IXmlGenerator.ts`:

```typescript
import type { Factura } from './Factura.js';
import type { Comercio } from '../comercio/Comercio.js';
import type { Cliente } from '../cliente/Cliente.js';

/** Puerto — Generación de XML del Documento Electrónico */
export interface IXmlGenerator {
  generarXml(factura: Factura, comercio: Comercio, cliente: Cliente): Promise<string>;
}
```

This port lives in domain because the application layer needs to call it. The infrastructure adapter implements it using the TIPS-SA library.

**Step 3: Create SifenDataMapper** in `src/infrastructure/sifen/SifenDataMapper.ts`:

This module contains pure mapping functions (no I/O, no side effects) that transform domain entities into the TIPS-SA `params` and `data` objects expected by `generateXMLDE(params, data, options)`.

Functions to create:

```typescript
// Mapea Comercio -> params (datos estáticos del emisor)
export function mapComercioToParams(comercio: Comercio): SifenParams

// Mapea Factura + Comercio + Cliente -> data (datos variables del DE)
export function mapFacturaToData(factura: Factura, comercio: Comercio, cliente: Cliente): SifenData

// Mapea ItemFactura[] -> items array para TIPS-SA
export function mapItemsToSifenItems(items: readonly ItemFactura[]): SifenItem[]
```

**SifenParams structure** (maps from Comercio entity):
```typescript
interface SifenParams {
  version: number;              // 150 (SIFEN manual version)
  ruc: string;                  // comercio.ruc.value (e.g., "80069563-1")
  razonSocial: string;          // comercio.razonSocial
  nombreFantasia: string;       // comercio.nombreFantasia
  actividadesEconomicas: Array<{ codigo: string; descripcion: string }>;
  timbradoNumero: string;       // comercio.timbrado.numero
  timbradoFecha: string;        // comercio.timbrado.fechaInicio formatted as YYYY-MM-DD
  tipoContribuyente: number;    // comercio.tipoContribuyente (1 or 2)
  tipoRegimen: number;          // 8 (default turismo/general) - hardcode for MVP
  establecimientos: Array<{
    codigo: string;             // comercio.establecimiento
    direccion: string;          // "Mercado Municipal" (default MVP)
    numeroCasa: string;         // "0" (default)
    departamento: number;       // 11 (Central, default MVP)
    departamentoDescripcion: string;
    distrito: number;           // 1 (default)
    distritoDescripcion: string;
    ciudad: number;             // 1 (default)
    ciudadDescripcion: string;
    telefono: string;           // "" (default)
    email: string;              // "" (default)
  }>;
}
```

NOTE: For MVP, some fields in Comercio entity don't exist yet (actividades economicas, address details). Hardcode sensible defaults:
- actividadesEconomicas: `[{ codigo: "47190", descripcion: "Venta al por menor de otros productos en comercios no especializados" }]`
- direccion: "Mercado Municipal"
- departamento: 11 (Central)
- tipoRegimen: 8

**SifenData structure** (maps from Factura + Cliente):
```typescript
interface SifenData {
  tipoDocumento: number;        // factura.tipoDocumento (1, 5, 6, 7)
  establecimiento: number;      // parseInt(factura.numeroFactura.establecimiento)
  punto: string;                // factura.numeroFactura.punto
  numero: string;               // factura.numeroFactura.numero
  descripcion: string;          // "Venta de productos" (default)
  observacion: string;          // "" (empty)
  fecha: string;                // factura.fechaEmision formatted as YYYY-MM-DDThh:mm:ss
  tipoEmision: number;          // factura.tipoEmision (1 or 2)
  tipoTransaccion: number;      // 1 (venta de mercadería)
  tipoImpuesto: number;         // 1 (IVA)
  moneda: string;               // "PYG"
  condicionAnticipo: null;      // null for MVP
  condicionTipoCambio: null;    // null for MVP
  cambio: null;                 // null for MVP

  // Código de seguridad del CDC
  codigoSeguridadAleatorio: string;  // factura.cdc.codigoSeguridad

  cliente: {
    contribuyente: boolean;     // cliente.tipoDocumento === 'RUC'
    ruc: string;                // cliente.rucCi (if RUC)
    razonSocial: string;        // cliente.nombre
    nombreFantasia: string;     // cliente.nombre
    tipoOperacion: number;      // 1 (B2B) if RUC, 2 (B2C) if CI/innominado
    direccion: string;          // cliente.direccion ?? "Sin dirección"
    numeroCasa: string;         // "0"
    departamento: number;       // 11 (default)
    departamentoDescripcion: string; // "Central"
    distrito: number;           // 1
    distritoDescripcion: string;
    ciudad: number;             // 1
    ciudadDescripcion: string;
    pais: string;               // "PRY"
    paisDescripcion: string;    // "Paraguay"
    tipoContribuyente: number;  // 1 (PF) or 2 (PJ) based on doc type
    documentoTipo: number;      // 1=CI, 2=pasaporte, 3=innominado, 4=otro (SIFEN catalog mapping)
    documentoNumero: string;    // cliente.rucCi
    telefono: string;           // cliente.telefono ?? ""
    celular: string;            // cliente.telefono ?? ""
    email: string;              // cliente.email ?? ""
  };

  usuario: {                    // Firmante/usuario
    documentoTipo: number;      // 1 (CI)
    documentoNumero: string;    // "0" (placeholder)
    nombre: string;             // "Usuario"
    cargo: string;              // "Vendedor"
  };

  items: SifenItem[];           // mapped from factura.items

  condicion: {
    tipo: number;               // 1=contado, 2=credito
    entregas: Array<{
      tipo: number;             // 1=efectivo, others for different methods
      monto: string;            // factura.totalBruto as string
      moneda: string;           // "PYG"
    }>;
  };
}
```

**SifenItem mapping** (from ItemFactura):
```typescript
interface SifenItem {
  codigo: string;               // sequential "1", "2", etc.
  descripcion: string;          // item.descripcion
  observacion: string;          // ""
  partidaArancelaria: null;     // null
  ncm: null;                    // null
  unidadMedida: number;         // 77 (unidad, default MVP)
  cantidad: number;             // item.cantidad
  frecuencia: null;             // null
  precioUnitario: number;       // item.precioUnitario
  cambio: null;                 // null
  descuento: null;              // null
  anticipo: null;               // null
  ppiAnticipo: null;            // null
  ppiPago: null;                // null
  tolerancia: null;             // null
  toleranciaPorcentaje: null;   // null
  toleranciaMonto: null;        // null
  ivaTipo: number;              // 1=gravado (10/5%), 3=exento (0%)
  ivaBase: number;              // 100 (porcentaje proporcion gravada, 100% for normal)
  iva: number;                  // item.tasaIVA (10, 5, 0)
  lpiPrecioUnitario: null;      // null (liquidación)
  lpiItemValor: null;           // null
  lpiPorcentaje: null;          // null
  sectorAutomotor: null;        // null
}
```

**Type mapping for TipoDocumentoIdentidad -> SIFEN documentoTipo:**
- 'RUC' -> contribute=true, use ruc field
- 'CI' -> documentoTipo=1
- 'pasaporte' -> documentoTipo=2
- 'innominado' -> documentoTipo=5

**Step 4: Write failing tests (RED)** in `tests/unit/infrastructure/sifen/SifenDataMapper.test.ts`:

Create test helpers that build domain entities with known values:
- `crearComercioTest()` - returns Comercio with RUC "80069563-1", razonSocial "Doña María S.A.", etc.
- `crearFacturaTest()` - returns Factura with 2 items (mandioca 10%, pollo 5%), CDC generated
- `crearClienteTest()` - returns Cliente with CI "1234567"

Test cases for `mapComercioToParams`:
1. "debe mapear RUC del comercio al campo ruc de params"
2. "debe incluir version 150"
3. "debe mapear timbrado correctamente"
4. "debe usar tipoContribuyente del comercio"

Test cases for `mapFacturaToData`:
5. "debe mapear tipoDocumento de la factura"
6. "debe mapear establecimiento y punto de expedición"
7. "debe mapear fecha emisión en formato ISO sin timezone"
8. "debe mapear datos del cliente receptor"
9. "debe mapear condición de pago contado"
10. "debe incluir codigoSeguridadAleatorio del CDC"

Test cases for `mapItemsToSifenItems`:
11. "debe mapear item con IVA 10% como ivaTipo 1, iva 10"
12. "debe mapear item con IVA 5% como ivaTipo 1, iva 5"
13. "debe mapear item exento como ivaTipo 3, iva 0"
14. "debe asignar códigos secuenciales a los items"
15. "debe mapear cantidad y precio unitario correctamente"

Run `npm test` and verify all tests FAIL (they reference functions that don't exist yet).

Commit: `test(02-01): add failing tests for SifenDataMapper (RED)`
  </action>
  <verify>
Run `cd nandefact-api && npx vitest run tests/unit/infrastructure/sifen/SifenDataMapper.test.ts` and verify that tests exist and FAIL because `SifenDataMapper.ts` exports are not yet implemented (or have stub implementations). The IXmlGenerator.ts port file must exist. The `facturacionelectronicapy-xmlgen` package must be in package.json dependencies.
  </verify>
  <done>
IXmlGenerator port interface exists in domain/factura/. SifenDataMapper.ts exists as a skeleton with exported function signatures. 15+ failing tests exist covering all mapping scenarios. facturacionelectronicapy-xmlgen is installed.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement SifenDataMapper + XmlGeneratorSifen (GREEN)</name>
  <files>
    nandefact-api/src/infrastructure/sifen/SifenDataMapper.ts
    nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts
    nandefact-api/tests/unit/infrastructure/sifen/XmlGeneratorSifen.test.ts
  </files>
  <action>
**Step 1: Implement SifenDataMapper mapping functions**

Implement all three functions (`mapComercioToParams`, `mapFacturaToData`, `mapItemsToSifenItems`) according to the mapping rules defined in Task 1. Ensure:

- All number types are correct (TIPS-SA expects numbers for some fields, strings for others)
- Date formatting: `YYYY-MM-DDThh:mm:ss` (ISO 8601 without timezone)
- Null fields are explicitly null (not undefined) because TIPS-SA xmlgen may skip undefined but error on missing required fields
- MontoIVA mapping: IVA 10/5 -> ivaTipo 1 (gravado), IVA 0 -> ivaTipo 3 (exento)
- ivaBase always 100 for MVP (no special proportions)
- condicion.tipo: 'contado' -> 1, 'credito' -> 2
- For MVP, condicion.entregas: single cash entry `[{ tipo: 1, monto: totalBruto.toString(), moneda: "PYG" }]`
- Handle innominado client: documentoTipo=5, documentoNumero="0", nombre="Sin Nombre"

Run tests after implementation and verify all SifenDataMapper tests PASS.

**Step 2: Create XmlGeneratorSifen adapter** in `src/infrastructure/sifen/XmlGeneratorSifen.ts`:

```typescript
import xmlgen from 'facturacionelectronicapy-xmlgen';
import type { IXmlGenerator } from '../../domain/factura/IXmlGenerator.js';
import type { Factura } from '../../domain/factura/Factura.js';
import type { Comercio } from '../../domain/comercio/Comercio.js';
import type { Cliente } from '../../domain/cliente/Cliente.js';
import { mapComercioToParams, mapFacturaToData } from './SifenDataMapper.js';

/** Adaptador — Genera XML del DE usando librería TIPS-SA xmlgen */
export class XmlGeneratorSifen implements IXmlGenerator {
  async generarXml(factura: Factura, comercio: Comercio, cliente: Cliente): Promise<string> {
    if (!factura.cdc) {
      throw new Error(`Factura ${factura.id} no tiene CDC generado`);
    }

    const params = mapComercioToParams(comercio);
    const data = mapFacturaToData(factura, comercio, cliente);

    const xml = await xmlgen.generateXMLDE(params, data);
    return xml;
  }
}
```

**Step 3: Write XmlGeneratorSifen integration test** in `tests/unit/infrastructure/sifen/XmlGeneratorSifen.test.ts`:

This test verifies that the adapter calls xmlgen with correctly mapped data and returns an XML string.

Test cases:
1. "debe generar XML string válido a partir de factura con items" - Creates test entities, calls generarXml(), verifies result is a non-empty string containing `<DE>` and the CDC value
2. "debe lanzar error si factura no tiene CDC" - Verifies error thrown for factura without CDC
3. "debe incluir datos del emisor en XML generado" - Verifies XML contains razonSocial
4. "debe incluir datos del receptor en XML generado" - Verifies XML contains cliente name

NOTE: These tests call the REAL xmlgen library (not mocked) because we need to verify our mapping produces valid input that the library accepts without errors. This is an integration-level test within unit test file, which is acceptable because xmlgen is a pure function with no I/O.

If the xmlgen library is a CommonJS module and causes ESM import issues, use `import * as xmlgen from 'facturacionelectronicapy-xmlgen'` or dynamic `const xmlgen = await import('facturacionelectronicapy-xmlgen')`. Check the library's export format and adjust accordingly.

Run all tests and verify PASS.

Commit: `feat(02-01): implement SifenDataMapper and XmlGeneratorSifen (GREEN)`
  </action>
  <verify>
Run `cd nandefact-api && npx vitest run tests/unit/infrastructure/sifen/` and verify ALL tests pass. Run `cd nandefact-api && npx vitest run` to verify zero regressions (all 81 existing tests + new tests pass). Run `npx tsc --noEmit` to verify TypeScript compiles without errors.
  </verify>
  <done>
SifenDataMapper correctly maps all domain entities to TIPS-SA format (15+ tests passing). XmlGeneratorSifen calls facturacionelectronicapy-xmlgen and produces valid XML string (4+ tests passing). All 81 existing tests still pass. TypeScript compiles clean.
  </done>
</task>

</tasks>

<verification>
1. `cd nandefact-api && npx vitest run` — All tests pass (81 existing + ~19 new = ~100 total)
2. `npx tsc --noEmit` — TypeScript compiles clean
3. `grep -r "facturacionelectronicapy-xmlgen" nandefact-api/package.json` — Library installed
4. `test -f nandefact-api/src/domain/factura/IXmlGenerator.ts` — Port exists in domain
5. `test -f nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts` — Adapter exists in infrastructure
6. `test -f nandefact-api/src/infrastructure/sifen/SifenDataMapper.ts` — Mapper exists in infrastructure
7. `grep "implements IXmlGenerator" nandefact-api/src/infrastructure/sifen/XmlGeneratorSifen.ts` — Adapter implements port
</verification>

<success_criteria>
- IXmlGenerator port is defined in domain layer (hexagonal architecture respected)
- SifenDataMapper maps Factura, Comercio, Cliente to TIPS-SA params/data format correctly
- XmlGeneratorSifen produces real XML via facturacionelectronicapy-xmlgen library
- All mapping edge cases tested (IVA 10%, 5%, exenta; contado; CI/RUC/innominado clients)
- Zero test regressions
</success_criteria>

<output>
After completion, create `.planning/phases/02-sifen-integration/02-01-SUMMARY.md`
</output>
