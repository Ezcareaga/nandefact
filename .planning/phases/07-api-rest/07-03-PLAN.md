---
phase: 07-api-rest
plan: 03
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/interfaces/http/schemas/productoSchemas.ts
  - src/interfaces/http/schemas/clienteSchemas.ts
  - src/interfaces/http/routes/productoRoutes.ts
  - src/interfaces/http/routes/clienteRoutes.ts
autonomous: true

must_haves:
  truths:
    - "GET /api/v1/productos returns paginated product list for authenticated user's comercio"
    - "POST /api/v1/productos creates a product with Zod-validated payload"
    - "PUT /api/v1/productos/:id updates product fields"
    - "DELETE /api/v1/productos/:id soft-deletes a product (sets activo=false)"
    - "GET /api/v1/clientes/buscar?q= returns matching clients (autocompletado)"
    - "POST /api/v1/clientes creates a client with validated CI/RUC/innominado type"
    - "All routes require JWT authentication"
  artifacts:
    - path: "src/interfaces/http/schemas/productoSchemas.ts"
      provides: "Zod schemas for producto endpoints"
      exports: ["crearProductoSchema", "editarProductoSchema", "listarProductosQuerySchema"]
    - path: "src/interfaces/http/schemas/clienteSchemas.ts"
      provides: "Zod schemas for cliente endpoints"
      exports: ["crearClienteSchema", "editarClienteSchema", "buscarClientesQuerySchema"]
    - path: "src/interfaces/http/routes/productoRoutes.ts"
      provides: "Express router for /api/v1/productos/*"
      exports: ["createProductoRouter"]
    - path: "src/interfaces/http/routes/clienteRoutes.ts"
      provides: "Express router for /api/v1/clientes/*"
      exports: ["createClienteRouter"]
  key_links:
    - from: "src/interfaces/http/routes/productoRoutes.ts"
      to: "src/application/productos/CrearProducto.ts"
      via: "use case execute"
      pattern: "crearProducto\\.execute"
    - from: "src/interfaces/http/routes/productoRoutes.ts"
      to: "src/application/productos/ListarProductos.ts"
      via: "use case execute"
      pattern: "listarProductos\\.execute"
    - from: "src/interfaces/http/routes/clienteRoutes.ts"
      to: "src/application/clientes/CrearCliente.ts"
      via: "use case execute"
      pattern: "crearCliente\\.execute"
    - from: "src/interfaces/http/routes/clienteRoutes.ts"
      to: "src/application/clientes/BuscarClientes.ts"
      via: "use case execute"
      pattern: "buscarClientes\\.execute"
---

<objective>
Create Zod validation schemas and Express route handlers for Productos (CRUD + pagination) and Clientes (CRUD + search autocomplete + RUC query). All routes require JWT authentication and scope operations to the authenticated user's comercioId.

Purpose: Productos and Clientes are the catalog data that Dona Maria manages before creating facturas. These CRUD endpoints let the app sync product/client data.
Output: 4 files - 2 Zod schema files + 2 route files, wired to existing use cases.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/ez/projects/nandefact/CLAUDE.md
@/home/ez/projects/nandefact/.planning/ROADMAP.md
@/home/ez/projects/nandefact/.planning/phases/07-api-rest/07-01-SUMMARY.md
@/home/ez/projects/nandefact/nandefact-api/src/application/productos/CrearProducto.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/productos/EditarProducto.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/productos/ListarProductos.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/clientes/CrearCliente.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/clientes/EditarCliente.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/clientes/BuscarClientes.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/clientes/ConsultarRUC.ts
@/home/ez/projects/nandefact/nandefact-api/src/domain/shared/types.ts
@/home/ez/projects/nandefact/nandefact-api/src/interfaces/http/app.ts
@/home/ez/projects/nandefact/nandefact-api/src/interfaces/http/middleware/validateRequest.ts
@/home/ez/projects/nandefact/nandefact-api/src/interfaces/http/middleware/authMiddleware.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas for producto and cliente endpoints</name>
  <files>
    src/interfaces/http/schemas/productoSchemas.ts
    src/interfaces/http/schemas/clienteSchemas.ts
  </files>
  <action>
    1. Create `src/interfaces/http/schemas/productoSchemas.ts`:
       - `crearProductoSchema`: body with:
         - nombre: z.string().trim().min(1).max(200)
         - precioUnitario: z.number().int().positive() (PYG, no decimals)
         - unidadMedida: z.string().trim().min(1).max(10)
         - tasaIVA: z.union([z.literal(10), z.literal(5), z.literal(0)])
         - codigo: z.string().trim().max(50).optional()
         - categoria: z.string().trim().max(100).optional()
       - `editarProductoSchema`:
         - params: z.object({ id: z.string().uuid() })
         - body: z.object with all crearProducto fields as optional PLUS activo: z.boolean().optional(). At least one field must be present (use .refine to check at least one key exists).
       - `listarProductosQuerySchema`: query with:
         - page: z.coerce.number().int().positive().optional().default(1)
         - pageSize: z.coerce.number().int().positive().max(100).optional().default(20)
         - soloActivos: z.coerce.boolean().optional().default(true)
       - `idParamSchema`: params with id: z.string().uuid() (reusable for DELETE)

    2. Create `src/interfaces/http/schemas/clienteSchemas.ts`:
       - `crearClienteSchema`: body with:
         - nombre: z.string().trim().min(1).max(200)
         - rucCi: z.string().trim().min(1).max(20)
         - tipoDocumento: z.enum(['RUC', 'CI', 'pasaporte', 'innominado'])
         - telefono: z.string().trim().max(20).optional()
         - email: z.string().email().optional()
         - direccion: z.string().trim().max(500).optional()
         - frecuente: z.boolean().optional()
         - enviarWhatsApp: z.boolean().optional()
       - `editarClienteSchema`:
         - params: z.object({ id: z.string().uuid() })
         - body: all crearCliente fields optional, refine at least one field present
       - `buscarClientesQuerySchema`: query with:
         - q: z.string().trim().min(2) (minimum 2 chars, matching BuscarClientes validation)
       - `consultarRUCQuerySchema`: query with:
         - ruc: z.string().trim().min(1)

    NOTE: For query parameters that come as strings, use z.coerce for numbers and booleans.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - All schemas defined with proper types matching use case Input DTOs
  </verify>
  <done>Zod schemas for producto CRUD (create, edit, list+pagination, delete) and cliente CRUD (create, edit, search, RUC query) with proper validation rules.</done>
</task>

<task type="auto">
  <name>Task 2: Create producto and cliente route handlers</name>
  <files>
    src/interfaces/http/routes/productoRoutes.ts
    src/interfaces/http/routes/clienteRoutes.ts
  </files>
  <action>
    1. Create `src/interfaces/http/routes/productoRoutes.ts`:
       - Export `createProductoRouter(deps: AppDependencies): Router`
       - Apply authMiddleware to ALL routes.
       - Routes:
         - `GET /`: validateRequest({ query: listarProductosQuerySchema }) -> deps.listarProductos.execute({ comercioId: req.user!.comercioId, page, pageSize, soloActivos }) -> 200 with { success: true, data: { productos, total, page, pageSize } }
         - `POST /`: validateRequest({ body: crearProductoSchema }) -> deps.crearProducto.execute({ comercioId: req.user!.comercioId, ...body }) -> 201 with { success: true, data: { productoId } }
         - `PUT /:id`: validateRequest({ params: idParamSchema, body: editarProductoSchema.shape.body }) -> deps.editarProducto.execute({ productoId: req.params.id, cambios: body }) -> 200 with { success: true, data: { message: "Producto actualizado" } }
         - `DELETE /:id`: validateRequest({ params: idParamSchema }) -> deps.editarProducto.execute({ productoId: req.params.id, cambios: { activo: false } }) -> 200 with { success: true, data: { message: "Producto desactivado" } }

       IMPORTANT: comercioId always comes from req.user!.comercioId (JWT), NEVER from request body. This prevents users from modifying another comercio's data.

    2. Create `src/interfaces/http/routes/clienteRoutes.ts`:
       - Export `createClienteRouter(deps: AppDependencies): Router`
       - Apply authMiddleware to ALL routes.
       - Routes:
         - `GET /`: load all clients for comercio via deps.clienteRepository.findByComercio(req.user!.comercioId) -> 200 with { success: true, data: { clientes } }. Map Cliente entities to plain objects (id, nombre, rucCi, tipoDocumento, telefono, email, direccion, frecuente, enviarWhatsApp).
         - `POST /`: validateRequest({ body: crearClienteSchema }) -> deps.crearCliente.execute({ comercioId: req.user!.comercioId, ...body }) -> 201 with { success: true, data: { clienteId } }
         - `PUT /:id`: validateRequest({ params: idParamSchema, body: editarClienteSchema.shape.body }) -> deps.editarCliente.execute({ clienteId: req.params.id, cambios: body }) -> 200 with { success: true, data: { message: "Cliente actualizado" } }
         - `GET /buscar`: validateRequest({ query: buscarClientesQuerySchema }) -> deps.buscarClientes.execute({ comercioId: req.user!.comercioId, query: req.query.q }) -> 200 with { success: true, data: { clientes } }
         - `GET /ruc`: validateRequest({ query: consultarRUCQuerySchema }) -> deps.consultarRUC.execute({ ruc: req.query.ruc }) -> 200 with { success: true, data: { encontrado, razonSocial, ruc } }

       IMPORTANT: Define `/buscar` and `/ruc` routes BEFORE `/:id` routes to prevent Express from matching "buscar" as an :id param.

    Use the same asyncHandler pattern from Plan 02 authRoutes. Reuse or import it from a shared location (if Plan 01 exports it from app.ts, use that; otherwise define locally or create a tiny shared utility).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx eslint src/interfaces/` passes
    - productoRoutes uses crearProducto, editarProducto, listarProductos use cases
    - clienteRoutes uses crearCliente, editarCliente, buscarClientes, consultarRUC use cases
    - All routes extract comercioId from req.user!.comercioId
  </verify>
  <done>Producto router exposes GET (paginated list), POST (create), PUT /:id (update), DELETE /:id (soft-delete). Cliente router exposes GET (list), POST (create), PUT /:id (update), GET /buscar (search), GET /ruc (SIFEN RUC query). All protected by JWT, scoped to user's comercio.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npx eslint src/interfaces/` passes
- Producto routes: 4 endpoints (GET, POST, PUT, DELETE)
- Cliente routes: 5 endpoints (GET, POST, PUT, GET /buscar, GET /ruc)
- All routes use validateRequest with Zod schemas
- All routes use authMiddleware (protected)
- comercioId comes from JWT (req.user), never from request body
</verification>

<success_criteria>
Producto and Cliente CRUD routes created with Zod validation and JWT protection. Pagination works for product listing. Client search supports autocomplete (min 2 chars). RUC query available. All routes delegate to existing use cases with comercioId from JWT. TypeScript compiles, ESLint passes.
</success_criteria>

<output>
After completion, create `.planning/phases/07-api-rest/07-03-SUMMARY.md`
</output>
