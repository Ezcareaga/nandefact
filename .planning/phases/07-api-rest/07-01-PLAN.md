---
phase: 07-api-rest
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/interfaces/http/app.ts
  - src/interfaces/http/middleware/errorHandler.ts
  - src/interfaces/http/middleware/validateRequest.ts
  - src/interfaces/http/middleware/authMiddleware.ts
autonomous: true

must_haves:
  truths:
    - "Express app handles JSON requests with cors and helmet"
    - "Invalid JSON or validation errors return structured error responses"
    - "Domain errors map to correct HTTP status codes (400, 404, 409, 422)"
    - "JWT auth middleware extracts and verifies token from Authorization header"
    - "Unauthenticated requests to protected routes receive 401"
  artifacts:
    - path: "src/interfaces/http/app.ts"
      provides: "Express app factory function"
      exports: ["createApp"]
    - path: "src/interfaces/http/middleware/errorHandler.ts"
      provides: "Global error handler mapping domain/application errors to HTTP"
      exports: ["errorHandler"]
    - path: "src/interfaces/http/middleware/validateRequest.ts"
      provides: "Zod validation middleware factory"
      exports: ["validateRequest"]
    - path: "src/interfaces/http/middleware/authMiddleware.ts"
      provides: "JWT authentication middleware"
      exports: ["authMiddleware"]
  key_links:
    - from: "src/interfaces/http/middleware/errorHandler.ts"
      to: "src/domain/errors/DomainError.ts"
      via: "instanceof check"
      pattern: "instanceof DomainError"
    - from: "src/interfaces/http/middleware/errorHandler.ts"
      to: "src/application/errors/ApplicationError.ts"
      via: "instanceof check"
      pattern: "instanceof ApplicationError"
    - from: "src/interfaces/http/middleware/authMiddleware.ts"
      to: "src/domain/auth/IAuthService.ts"
      via: "verificarAccessToken call"
      pattern: "verificarAccessToken"
---

<objective>
Install Express, Zod, and HTTP dependencies. Create the Express app factory with CORS, helmet, JSON parsing, and the three core middleware: global error handler (maps domain/application errors to HTTP status codes), Zod validation middleware (validates request body/params/query against schemas), and JWT auth middleware (extracts Bearer token, verifies via IAuthService, attaches user to request).

Purpose: Foundation for all API routes. Without middleware, no route can handle errors, validate input, or authenticate users.
Output: Working Express app with middleware, ready to mount routes.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/ez/projects/nandefact/CLAUDE.md
@/home/ez/projects/nandefact/.planning/ROADMAP.md
@/home/ez/projects/nandefact/nandefact-api/package.json
@/home/ez/projects/nandefact/nandefact-api/tsconfig.json
@/home/ez/projects/nandefact/nandefact-api/src/domain/errors/DomainError.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/errors/ApplicationError.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/errors/FacturaNoEncontradaError.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/errors/FacturaNoAnulableError.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/errors/CuentaBloqueadaError.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/errors/ValidacionInputError.ts
@/home/ez/projects/nandefact/nandefact-api/src/domain/auth/IAuthService.ts
@/home/ez/projects/nandefact/nandefact-api/src/domain/shared/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install HTTP dependencies and create Express app</name>
  <files>
    package.json
    src/interfaces/http/app.ts
  </files>
  <action>
    1. Install production dependencies: `npm install express cors helmet zod`
    2. Install dev dependencies: `npm install -D @types/express @types/cors`

    3. Create `src/interfaces/http/app.ts`:
       - Export a `createApp` factory function that accepts a dependencies object (containing IAuthService for middleware injection).
       - Configure Express app with:
         - `express.json({ limit: '1mb' })` for JSON parsing
         - `cors()` with default settings (tighten in production later)
         - `helmet()` for security headers
       - The factory returns the configured Express app (do NOT mount routes here yet; routes will be added in later plans).
       - Do NOT start listening (that's server.ts in Plan 04).
       - Export the `AppDependencies` type so routes can share it.

    The AppDependencies type should include ALL use cases and ports needed by all routes. Structure:
    ```typescript
    export interface AppDependencies {
      // Auth
      autenticarUsuario: AutenticarUsuario;
      refrescarToken: RefrescarToken;
      authService: IAuthService;
      // Comercio
      registrarComercio: RegistrarComercio;
      cargarCertificado: CargarCertificado;
      configurarTimbrado: ConfigurarTimbrado;
      // Productos
      crearProducto: CrearProducto;
      editarProducto: EditarProducto;
      listarProductos: ListarProductos;
      // Clientes
      crearCliente: CrearCliente;
      editarCliente: EditarCliente;
      buscarClientes: BuscarClientes;
      consultarRUC: ConsultarRUC;
      // Facturas
      crearFactura: CrearFactura;
      enviarDE: EnviarDE;
      anularFactura: AnularFactura;
      enviarKuDE: EnviarKuDE;
      inutilizarNumeracion: InutilizarNumeracion;
      // Sync
      encolarFactura: EncolarFactura;
      sincronizarPendientes: SincronizarPendientes;
      // Repos (for direct queries in routes, e.g., GET facturas list)
      facturaRepository: IFacturaRepository;
      comercioRepository: IComercioRepository;
      clienteRepository: IClienteRepository;
    }
    ```

    Also extend Express Request type to include authenticated user:
    ```typescript
    declare global {
      namespace Express {
        interface Request {
          user?: {
            usuarioId: string;
            comercioId: string;
            rol: RolUsuario;
          };
        }
      }
    }
    ```
  </action>
  <verify>
    - `npm ls express` shows express installed
    - `npm ls zod` shows zod installed
    - `npx tsc --noEmit` compiles without errors
  </verify>
  <done>Express, Zod, cors, helmet installed. App factory creates configured Express instance. AppDependencies type defined with all 16 use cases + 3 repos.</done>
</task>

<task type="auto">
  <name>Task 2: Create error handler, validation, and auth middleware</name>
  <files>
    src/interfaces/http/middleware/errorHandler.ts
    src/interfaces/http/middleware/validateRequest.ts
    src/interfaces/http/middleware/authMiddleware.ts
  </files>
  <action>
    1. Create `src/interfaces/http/middleware/errorHandler.ts`:
       - Export Express error-handling middleware (4 params: err, req, res, next).
       - Map errors to HTTP responses with consistent structure: `{ success: false, error: { code: string, message: string } }`
       - Error mapping:
         - `ValidacionInputError` -> 400 Bad Request, code: "VALIDACION_INPUT"
         - `DomainError` (catch-all for CDCInvalidoError, RUCInvalidoError, MontoInvalidoError, etc.) -> 400 Bad Request, code: error.name
         - `CredencialesInvalidasError` -> 401 Unauthorized, code: "CREDENCIALES_INVALIDAS"
         - `CuentaBloqueadaError` -> 429 Too Many Requests, code: "CUENTA_BLOQUEADA"
         - `FacturaNoEncontradaError`, `ComercioNoEncontradoError`, `ProductoNoEncontradoError`, `ClienteNoEncontradoError` -> 404 Not Found, code: error.name
         - `FacturaNoAnulableError`, `FacturaInmutableError`, `EstadoInconsistenteError` -> 409 Conflict, code: error.name
         - `KuDENoGenerableError`, `RucDuplicadoError` -> 422 Unprocessable Entity, code: error.name
         - `ApplicationError` (catch-all) -> 422, code: error.name
         - `ZodError` (from zod validation) -> 400, code: "VALIDACION", message: formatted zod issues
         - Unknown errors -> 500 Internal Server Error, code: "ERROR_INTERNO", message: "Error interno del servidor" (NEVER expose stack trace in response)
       - Log the full error (with stack) to console for debugging, but NEVER include stack in response.
       - Order matters: check specific error classes BEFORE base classes (CredencialesInvalidasError before ApplicationError).

    2. Create `src/interfaces/http/middleware/validateRequest.ts`:
       - Export a `validateRequest` function that takes a Zod schema config object:
         ```typescript
         interface ValidationSchemas {
           body?: ZodSchema;
           params?: ZodSchema;
           query?: ZodSchema;
         }
         ```
       - Returns Express middleware that validates req.body/params/query against schemas.
       - On validation success, replace req.body/params/query with parsed (type-safe) values.
       - On validation failure, call `next(zodError)` to let errorHandler format it.

    3. Create `src/interfaces/http/middleware/authMiddleware.ts`:
       - Export a factory function `createAuthMiddleware(authService: IAuthService)` that returns Express middleware.
       - Middleware extracts Bearer token from `Authorization` header.
       - If no header or no Bearer prefix -> 401 with `{ success: false, error: { code: "NO_AUTENTICADO", message: "Token de autenticación requerido" } }`.
       - Calls `authService.verificarAccessToken(token)`.
       - On success, attaches payload to `req.user = { usuarioId, comercioId, rol }`.
       - On verification failure (expired, invalid) -> 401 with `{ success: false, error: { code: "TOKEN_INVALIDO", message: "Token inválido o expirado" } }`.
       - NEVER log the token value itself.

    All middleware uses `.js` extension in imports (ESM).
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx eslint src/interfaces/` passes
  </verify>
  <done>Three middleware files created: errorHandler maps all 27 error classes to proper HTTP codes, validateRequest wraps Zod schemas, authMiddleware verifies JWT Bearer tokens. All compile and lint clean.</done>
</task>

</tasks>

<verification>
- `npm ls express zod cors helmet` all show installed
- `npx tsc --noEmit` passes with zero errors
- `npx eslint src/interfaces/` passes
- errorHandler.ts imports and instanceof-checks DomainError and ApplicationError (and specific subclasses)
- authMiddleware.ts uses IAuthService.verificarAccessToken
- validateRequest.ts uses Zod parse
</verification>

<success_criteria>
Express app factory exists and creates configured app with cors, helmet, JSON parsing. Error handler maps domain/application errors to HTTP status codes with consistent response format. Validation middleware wraps Zod schemas for body/params/query. Auth middleware verifies JWT Bearer tokens via IAuthService port. All TypeScript compiles, all ESLint passes. No routes mounted yet (that's Plans 02-04).
</success_criteria>

<output>
After completion, create `.planning/phases/07-api-rest/07-01-SUMMARY.md`
</output>
