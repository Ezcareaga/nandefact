---
phase: 07-api-rest
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/interfaces/http/schemas/authSchemas.ts
  - src/interfaces/http/schemas/comercioSchemas.ts
  - src/interfaces/http/routes/authRoutes.ts
  - src/interfaces/http/routes/comercioRoutes.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/v1/auth/login accepts telefono + pin and returns JWT tokens"
    - "POST /api/v1/auth/refresh accepts refresh token and returns new token pair"
    - "GET /api/v1/comercio/perfil returns comercio data for authenticated user"
    - "POST /api/v1/comercio/certificado accepts .p12 file upload"
    - "PUT /api/v1/comercio/timbrado updates timbrado configuration"
    - "Invalid login payload returns 400 with Zod validation errors"
  artifacts:
    - path: "src/interfaces/http/schemas/authSchemas.ts"
      provides: "Zod schemas for auth endpoints"
      exports: ["loginSchema", "refreshSchema"]
    - path: "src/interfaces/http/schemas/comercioSchemas.ts"
      provides: "Zod schemas for comercio endpoints"
      exports: ["registrarComercioSchema", "certificadoSchema", "timbradoSchema"]
    - path: "src/interfaces/http/routes/authRoutes.ts"
      provides: "Express router for /api/v1/auth/*"
      exports: ["createAuthRouter"]
    - path: "src/interfaces/http/routes/comercioRoutes.ts"
      provides: "Express router for /api/v1/comercio/*"
      exports: ["createComercioRouter"]
  key_links:
    - from: "src/interfaces/http/routes/authRoutes.ts"
      to: "src/application/auth/AutenticarUsuario.ts"
      via: "use case execute"
      pattern: "autenticarUsuario\\.execute"
    - from: "src/interfaces/http/routes/authRoutes.ts"
      to: "src/application/auth/RefrescarToken.ts"
      via: "use case execute"
      pattern: "refrescarToken\\.execute"
    - from: "src/interfaces/http/routes/comercioRoutes.ts"
      to: "src/application/comercio/RegistrarComercio.ts"
      via: "use case execute"
      pattern: "registrarComercio\\.execute"
---

<objective>
Create Zod validation schemas and Express route handlers for Auth (login, refresh) and Comercio (perfil, certificado, timbrado, registro) endpoints. Auth routes are public (no JWT required). Comercio routes are protected (require authMiddleware).

Purpose: Auth endpoints are the entry point for all API usage (get tokens first). Comercio endpoints enable comercio onboarding and configuration.
Output: 4 files - 2 Zod schema files + 2 route files, all wired to existing use cases.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/home/ez/projects/nandefact/CLAUDE.md
@/home/ez/projects/nandefact/.planning/ROADMAP.md
@/home/ez/projects/nandefact/.planning/phases/07-api-rest/07-01-SUMMARY.md
@/home/ez/projects/nandefact/nandefact-api/src/application/auth/AutenticarUsuario.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/auth/RefrescarToken.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/comercio/RegistrarComercio.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/comercio/CargarCertificado.ts
@/home/ez/projects/nandefact/nandefact-api/src/application/comercio/ConfigurarTimbrado.ts
@/home/ez/projects/nandefact/nandefact-api/src/interfaces/http/app.ts
@/home/ez/projects/nandefact/nandefact-api/src/interfaces/http/middleware/validateRequest.ts
@/home/ez/projects/nandefact/nandefact-api/src/interfaces/http/middleware/authMiddleware.ts
@/home/ez/projects/nandefact/nandefact-api/src/interfaces/http/middleware/errorHandler.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Zod schemas for auth and comercio endpoints</name>
  <files>
    src/interfaces/http/schemas/authSchemas.ts
    src/interfaces/http/schemas/comercioSchemas.ts
  </files>
  <action>
    1. Create `src/interfaces/http/schemas/authSchemas.ts`:
       - `loginSchema`: body with `telefono` (string, non-empty, trimmed) and `pin` (string, regex /^\d{4,6}$/ per AutenticarUsuario validation).
       - `refreshSchema`: body with `refreshToken` (string, non-empty).

    2. Create `src/interfaces/http/schemas/comercioSchemas.ts`:
       - `registrarComercioSchema`: body with all RegistrarComercioInput fields:
         - Required: ruc (string, min 1), razonSocial (string, min 1, max 200), nombreFantasia (string, min 1, max 200), timbradoNumero (string, min 1), timbradoFechaInicio (string, coerce to Date via z.coerce.date()), timbradoFechaFin (string, coerce to Date), establecimiento (string, regex /^\d{3}$/), puntoExpedicion (string, regex /^\d{3}$/), tipoContribuyente (z.literal(1).or(z.literal(2)))
         - Optional: direccion, numeroCasa, departamento (number), departamentoDesc, distrito (number), distritoDesc, ciudad (number), ciudadDesc, telefono, email (z.string().email()), rubro, actividadEconomicaCodigo, actividadEconomicaDesc, tipoRegimen (number), cscId
       - `certificadoParamsSchema`: no body schema needed (file upload handled differently); just validate comercioId comes from req.user.comercioId (not from params). The password field comes from a form field. NOTE: For certificate upload, the route will use express raw/multer - schema just validates the password field exists.
       - `timbradoSchema`: body with timbradoNumero (string, min 1), fechaInicio (z.coerce.date()), fechaFin (z.coerce.date()).

    Use z.object() for all schemas. Export each named schema.
    All string fields that accept user input should have .trim() applied.
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - Schemas parse valid test data correctly (verified during route testing)
  </verify>
  <done>Zod schemas created for all auth and comercio endpoints with proper validation rules matching use case input DTOs.</done>
</task>

<task type="auto">
  <name>Task 2: Create auth and comercio route handlers</name>
  <files>
    src/interfaces/http/routes/authRoutes.ts
    src/interfaces/http/routes/comercioRoutes.ts
  </files>
  <action>
    1. Create `src/interfaces/http/routes/authRoutes.ts`:
       - Export `createAuthRouter(deps: AppDependencies): Router`
       - Routes (NO authMiddleware - these are public):
         - `POST /login`: validateRequest({ body: loginSchema }) -> call deps.autenticarUsuario.execute({ telefono, pin }) -> return 200 with { success: true, data: { accessToken, refreshToken, expiresIn, usuario } }
         - `POST /refresh`: validateRequest({ body: refreshSchema }) -> call deps.refrescarToken.execute({ refreshToken }) -> return 200 with { success: true, data: { accessToken, refreshToken, expiresIn } }
       - All route handlers wrap use case calls in try/catch and pass errors to next() for errorHandler.
       - Use async handler wrapper pattern to catch async errors:
         ```typescript
         const asyncHandler = (fn: RequestHandler): RequestHandler =>
           (req, res, next) => Promise.resolve(fn(req, res, next)).catch(next);
         ```

    2. Create `src/interfaces/http/routes/comercioRoutes.ts`:
       - Export `createComercioRouter(deps: AppDependencies): Router`
       - Apply authMiddleware to ALL routes in this router.
       - Routes:
         - `POST /registrar`: validateRequest({ body: registrarComercioSchema }) -> call deps.registrarComercio.execute(body with dates parsed) -> return 201 with { success: true, data: { comercioId } }
         - `GET /perfil`: load comercio from deps.comercioRepository.findById(req.user!.comercioId) -> if not found return 404 -> return 200 with { success: true, data: { comercio properties } }
         - `POST /certificado`: Accept multipart/form-data. Use express built-in or a simple buffer approach. Read the .p12 file from request. Extract password from form field. Call deps.cargarCertificado.execute({ comercioId: req.user!.comercioId, certificadoPkcs12: buffer, password }) -> return 200 with { success: true, data: { message: "Certificado cargado exitosamente" } }. NOTE: For the file upload, install `multer` (npm install multer @types/multer) and configure single file upload with memoryStorage.
         - `PUT /timbrado`: validateRequest({ body: timbradoSchema }) -> call deps.configurarTimbrado.execute({ comercioId: req.user!.comercioId, ...body }) -> return 200 with { success: true, data: { message: "Timbrado actualizado" } }

    Response pattern for ALL routes:
    ```typescript
    // Success
    res.status(200).json({ success: true, data: { ... } });
    // or 201 for creation
    res.status(201).json({ success: true, data: { ... } });
    ```

    Error responses are handled by errorHandler middleware (just call next(error)).

    IMPORTANT: Install multer for file upload: `npm install multer && npm install -D @types/multer`
  </action>
  <verify>
    - `npx tsc --noEmit` passes
    - `npx eslint src/interfaces/` passes
    - Routes reference correct use cases from AppDependencies
  </verify>
  <done>Auth router exposes POST /login and POST /refresh (public). Comercio router exposes POST /registrar, GET /perfil, POST /certificado (multer file upload), PUT /timbrado (all protected). All routes use Zod validation, delegate to use cases, and pass errors to global error handler.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- `npx eslint src/interfaces/` passes
- authRoutes.ts calls autenticarUsuario.execute and refrescarToken.execute
- comercioRoutes.ts calls registrarComercio.execute, cargarCertificado.execute, configurarTimbrado.execute
- All routes use validateRequest middleware with Zod schemas
- comercioRoutes applies authMiddleware to all routes
- Consistent response format: { success: boolean, data?: T, error?: { code, message } }
</verification>

<success_criteria>
Auth and Comercio routes created with Zod validation. Auth routes are public. Comercio routes require JWT. File upload works via multer for certificate. All routes delegate to existing use cases. TypeScript compiles, ESLint passes.
</success_criteria>

<output>
After completion, create `.planning/phases/07-api-rest/07-02-SUMMARY.md`
</output>
