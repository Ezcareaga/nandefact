---
phase: 03-sync-queue
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - nandefact-api/src/domain/sync/ISyncQueue.ts
  - nandefact-api/src/domain/sync/SyncJob.ts
  - nandefact-api/src/application/sync/ProcesarColaSifen.ts
  - nandefact-api/src/application/sync/EncolarFactura.ts
  - nandefact-api/tests/unit/application/sync/ProcesarColaSifen.test.ts
  - nandefact-api/tests/unit/application/sync/EncolarFactura.test.ts
autonomous: true

must_haves:
  truths:
    - "ProcesarColaSifen dequeues jobs in FIFO order and processes each factura through sign-send-update flow"
    - "EncolarFactura enqueues a factura job with comercioId, facturaId, CDC, and fechaEmision"
    - "System skips facturas older than 72 hours from queue processing and marks them as expired"
    - "System continues processing remaining jobs when one job fails"
    - "Failed jobs are re-enqueued with incremented attempt count for retry"
  artifacts:
    - path: "nandefact-api/src/domain/sync/ISyncQueue.ts"
      provides: "Port interface for async job queue"
      contains: "ISyncQueue"
    - path: "nandefact-api/src/domain/sync/SyncJob.ts"
      provides: "Value object representing a sync queue job"
      contains: "SyncJob"
    - path: "nandefact-api/src/application/sync/ProcesarColaSifen.ts"
      provides: "Use case that processes queued factura jobs"
      contains: "ProcesarColaSifen"
    - path: "nandefact-api/src/application/sync/EncolarFactura.ts"
      provides: "Use case that enqueues a factura for async SIFEN processing"
      contains: "EncolarFactura"
    - path: "nandefact-api/tests/unit/application/sync/ProcesarColaSifen.test.ts"
      provides: "Tests for queue-based sync processing"
    - path: "nandefact-api/tests/unit/application/sync/EncolarFactura.test.ts"
      provides: "Tests for factura enqueue use case"
  key_links:
    - from: "nandefact-api/src/application/sync/ProcesarColaSifen.ts"
      to: "nandefact-api/src/domain/sync/ISyncQueue.ts"
      via: "dependency injection"
      pattern: "syncQueue.*ISyncQueue"
    - from: "nandefact-api/src/application/sync/ProcesarColaSifen.ts"
      to: "nandefact-api/src/domain/factura/IFacturaRepository.ts"
      via: "dependency injection"
      pattern: "facturaRepository.*IFacturaRepository"
    - from: "nandefact-api/src/application/sync/EncolarFactura.ts"
      to: "nandefact-api/src/domain/sync/ISyncQueue.ts"
      via: "dependency injection"
      pattern: "syncQueue.*ISyncQueue"
---

<objective>
Create the domain port and application use cases for queue-based SIFEN sync processing.

Purpose: Replace the current synchronous batch sync with a queue-driven approach. Define the ISyncQueue port (hexagonal pattern), the SyncJob value object, and two use cases: EncolarFactura (enqueue) and ProcesarColaSifen (dequeue and process). Include 72-hour window enforcement so expired facturas are skipped.

Output: Domain sync port, SyncJob value object, two application use cases with full TDD test suites.
</objective>

<execution_context>
@/home/ez/.claude/get-shit-done/workflows/execute-plan.md
@/home/ez/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@nandefact-api/src/domain/factura/IFacturaRepository.ts
@nandefact-api/src/domain/factura/ISifenGateway.ts
@nandefact-api/src/domain/factura/IFirmaDigital.ts
@nandefact-api/src/domain/factura/IXmlGenerator.ts
@nandefact-api/src/domain/factura/Factura.ts
@nandefact-api/src/domain/comercio/IComercioRepository.ts
@nandefact-api/src/domain/cliente/IClienteRepository.ts
@nandefact-api/src/domain/shared/types.ts
@nandefact-api/src/application/sync/SincronizarPendientes.ts
@nandefact-api/tests/unit/application/sync/SincronizarPendientes.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SyncJob value object and ISyncQueue domain port</name>
  <files>
    nandefact-api/src/domain/sync/SyncJob.ts,
    nandefact-api/src/domain/sync/ISyncQueue.ts
  </files>
  <action>
Create the domain layer types for queue-based sync:

**SyncJob value object** (`src/domain/sync/SyncJob.ts`):
```typescript
export interface SyncJobProps {
  id: string;
  comercioId: string;
  facturaId: string;
  cdc: string;
  fechaEmision: Date;
  intentos: number;       // current attempt count (starts at 0)
  maxIntentos: number;    // max retries (default 5)
  ultimoError?: string;   // last error message
  creadoEn: Date;         // when job was enqueued
}
```
- SyncJob is immutable (readonly props)
- Add method `estaExpirado(): boolean` — returns true if `fechaEmision` is more than 72 hours ago from `Date.now()`
- Add method `puedeReintentar(): boolean` — returns true if `intentos < maxIntentos`
- Add method `conError(error: string): SyncJob` — returns new SyncJob with intentos+1 and ultimoError set
- Add static `HORAS_LIMITE = 72` constant
- Add static `MAX_INTENTOS_DEFAULT = 5` constant

**ISyncQueue port** (`src/domain/sync/ISyncQueue.ts`):
```typescript
export interface ISyncQueue {
  encolar(job: SyncJob): Promise<void>;
  desencolar(): Promise<SyncJob | null>;
  completar(jobId: string): Promise<void>;
  fallar(job: SyncJob, error: string): Promise<void>;
  obtenerPendientes(comercioId: string): Promise<SyncJob[]>;
  contarPendientes(comercioId: string): Promise<number>;
}
```

This follows the hexagonal pattern: domain defines the port, infrastructure will implement it with BullMQ in plan 03-02.

No tests needed for this task — the SyncJob will be tested through the use case tests in Task 2.
  </action>
  <verify>TypeScript compiles: `cd nandefact-api && npx tsc --noEmit`</verify>
  <done>SyncJob value object exists with estaExpirado(), puedeReintentar(), conError() methods. ISyncQueue port interface exists with encolar/desencolar/completar/fallar methods.</done>
</task>

<task type="auto">
  <name>Task 2: TDD — EncolarFactura use case + ProcesarColaSifen use case</name>
  <files>
    nandefact-api/src/application/sync/EncolarFactura.ts,
    nandefact-api/src/application/sync/ProcesarColaSifen.ts,
    nandefact-api/tests/unit/application/sync/EncolarFactura.test.ts,
    nandefact-api/tests/unit/application/sync/ProcesarColaSifen.test.ts
  </files>
  <action>
TDD approach: Write tests RED first, then implement GREEN.

**EncolarFactura use case** — Takes a facturaId, loads the factura from repo, creates a SyncJob, and enqueues it.

Input: `{ facturaId: string }`
Output: `{ jobId: string; cdc: string }`

Dependencies (injected):
- `facturaRepository: IFacturaRepository`
- `syncQueue: ISyncQueue`

Logic:
1. Load factura by id. Throw `FacturaNoEncontradaError` if not found.
2. Validate factura has CDC (throw if not — can't sync without CDC).
3. Validate factura is in estado 'pendiente' (throw if not — only pending facturas need sync).
4. Create SyncJob from factura data (id=UUID, comercioId, facturaId, cdc, fechaEmision, intentos=0, maxIntentos=5, creadoEn=now).
5. Call `syncQueue.encolar(job)`.
6. Return `{ jobId: job.id, cdc: factura.cdc.value }`.

Tests for EncolarFactura:
- Should enqueue a pending factura successfully
- Should throw FacturaNoEncontradaError when factura doesn't exist
- Should throw error when factura has no CDC
- Should throw error when factura is not in pendiente state (e.g., aprobado)

**ProcesarColaSifen use case** — Processes a single SyncJob from the queue. Called by the worker for each dequeued job.

Input: `{ job: SyncJob }`
Output: `{ exito: boolean; facturaId: string; cdc: string; error?: string }`

Dependencies (injected):
- `facturaRepository: IFacturaRepository`
- `comercioRepository: IComercioRepository`
- `clienteRepository: IClienteRepository`
- `xmlGenerator: IXmlGenerator`
- `firmaDigital: IFirmaDigital`
- `sifenGateway: ISifenGateway`
- `syncQueue: ISyncQueue`
- `logger: ILogger` (see below)

**ILogger interface** — Create `src/domain/shared/ILogger.ts`:
```typescript
export interface ILogger {
  info(message: string, context?: Record<string, unknown>): void;
  warn(message: string, context?: Record<string, unknown>): void;
  error(message: string, context?: Record<string, unknown>): void;
}
```

Logic for ProcesarColaSifen:
1. Log start: `logger.info('Procesando job', { jobId, comercioId, cdc, intento: job.intentos + 1 })`
2. Check if job `estaExpirado()`. If yes:
   - Log warning: `logger.warn('Factura expirada (>72h)', { facturaId, cdc, fechaEmision })`
   - Call `syncQueue.completar(job.id)` (remove from queue, don't retry expired jobs)
   - Return `{ exito: false, facturaId, cdc, error: 'Factura expirada: superó ventana de 72 horas SIFEN' }`
3. Load factura, comercio, cliente (same pattern as SincronizarPendientes.procesarFactura)
4. If factura not found or already aprobado/rechazado, complete job and return.
5. Mark factura as enviada, generate XML, sign, send to SIFEN.
6. Update factura state based on SIFEN response (0260/0261 = aprobado, else rechazado).
7. Save factura.
8. Call `syncQueue.completar(job.id)`.
9. Log result: `logger.info('Job completado', { facturaId, cdc, resultado: estado })`
10. Return `{ exito: true, facturaId, cdc }`.
11. On error:
    - If `job.puedeReintentar()`:
      - Call `syncQueue.fallar(job, error.message)` (adapter will re-enqueue with backoff)
      - Log: `logger.error('Job fallido, reintentando', { facturaId, cdc, intento, error })`
    - Else:
      - Call `syncQueue.completar(job.id)` (give up after max retries)
      - Log: `logger.error('Job fallido, máximo reintentos alcanzado', { facturaId, cdc, intentos })`
    - Return `{ exito: false, facturaId, cdc, error: message }`

Tests for ProcesarColaSifen:
- Should process a valid job: load factura, sign XML, send to SIFEN, update estado, complete job
- Should skip expired factura (>72h) and complete the job
- Should handle SIFEN rejection (0300): mark rechazada, complete job (no retry for SIFEN rejections)
- Should re-enqueue on network error when retries remaining (call syncQueue.fallar)
- Should give up after max retries (call syncQueue.completar)
- Should log all processing with comercioId and CDC context
- Should skip already-approved facturas (complete job without processing)

Use the same test helpers from the existing SincronizarPendientes.test.ts (crearFacturaPendiente pattern, mock setup).
  </action>
  <verify>`cd nandefact-api && npx vitest run tests/unit/application/sync/` — all tests pass</verify>
  <done>EncolarFactura and ProcesarColaSifen use cases implemented with full test coverage. Tests verify FIFO processing, 72-hour expiration, retry on failure, give up after max retries, structured logging with comercioId and CDC.</done>
</task>

</tasks>

<verification>
```bash
cd nandefact-api
npx tsc --noEmit                           # TypeScript compiles
npx vitest run tests/unit/application/sync/ # All sync tests pass
npx vitest run                             # All 140+ tests pass (no regressions)
```
</verification>

<success_criteria>
1. ISyncQueue port exists in domain layer with encolar/desencolar/completar/fallar methods
2. SyncJob value object has estaExpirado() (72h check) and puedeReintentar() methods
3. EncolarFactura use case creates SyncJob and enqueues via ISyncQueue port
4. ProcesarColaSifen use case processes a single job through the full SIFEN flow
5. Expired jobs (>72h) are skipped and completed
6. Failed jobs are re-enqueued when retries remain, completed when max retries exceeded
7. ILogger port exists for structured logging
8. All existing 140 tests still pass (zero regressions)
</success_criteria>

<output>
After completion, create `.planning/phases/03-sync-queue/03-01-SUMMARY.md`
</output>
